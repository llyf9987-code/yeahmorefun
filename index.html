<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Happy Birthday Xiao Ye! | Usagi Wishes</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Fredoka:wght@300;400;600&family=Zeyada&family=ZCOOL+KuaiLe&family=Playfair+Display:ital,wght@0,400;0,700;1,400&display=swap" rel="stylesheet">
    
    <!-- MediaPipe Hands -->
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands@0.4.1646424915/hands.js" crossorigin="anonymous"></script>
    
    <!-- Babel for in-browser compilation -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <script>
      tailwind.config = {
        theme: {
          extend: {
            colors: {
              usagi: {
                main: '#F9D59B', orange: '#FBBF77', gold: '#F8C860',
                pink: '#F8C8DC', text: '#5D4037', light: '#FFFBE6', hover: '#F7C070',
                cream: '#FFF9E6', wood: '#8D6E63', woodDark: '#5D4037'
              },
              vinyl: {
                bg: '#1a1510',
                gold: '#C5A059',
                goldDim: '#6b5735',
                text: '#E8DCC5'
              }
            },
            fontFamily: {
              sans: ['Fredoka', 'sans-serif'],
              hand: ['Zeyada', 'cursive'],
              cute: ['"ZCOOL KuaiLe"', 'cursive'],
              serif: ['"Playfair Display"', 'serif'],
            },
            animation: {
              'float': 'float 3s ease-in-out infinite',
              'bounce-slow': 'bounce 2s infinite',
              'drift': 'drift 10s linear infinite',
              'spin-slow': 'spin 8s linear infinite',
              'spin-vinyl': 'spin 4s linear infinite',
              'pulse-slow': 'pulse 4s cubic-bezier(0.4, 0, 0.6, 1) infinite',
            },
            keyframes: {
              float: { '0%, 100%': { transform: 'translateY(0)' }, '50%': { transform: 'translateY(-10px)' } },
              drift: { '0%': { transform: 'translateY(0) rotate(0deg)', opacity: '0' }, '50%': { opacity: '0.5' }, '100%': { transform: 'translateY(100px) rotate(180deg)', opacity: '0' } }
            },
            boxShadow: {
              'soft': '0 8px 32px rgba(93, 64, 55, 0.15)',
              'glow': '0 0 15px rgba(240, 98, 146, 0.5)',
              'vinyl': '0 4px 15px rgba(0,0,0,0.6), inset 0 0 0 2px #111, inset 0 0 0 10px #333',
              'gold-glow': '0 0 20px rgba(197, 160, 89, 0.3)',
            }
          }
        }
      }
    </script>
    <style>
      /* Apply cursor to html and body with specific hotspot coordinates (0 0) */
      html, body { 
        background-color: #F9D59B; 
        overflow-x: hidden; 
        cursor: url('https://test.fukit.cn/autoupload/f/IeSYb0Mnf1Z62nIKYGB4NyfNcKcqEnRmcljopnyJoMs/20251214/B4LO/32X33/usagi-cursor.png/webp') 0 0, auto !important;
      }
      
      .scrollbar-hide::-webkit-scrollbar { display: none; }
      .mirror-x { transform: scaleX(-1); }
      
      /* Refined Glassmorphism */
      .glass-card {
        background: rgba(0, 0, 0, 0.25);
        backdrop-filter: blur(10px);
        -webkit-backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 255, 255, 0.15);
        box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.3);
      }

      /* Text Shadow Utilities for Title */
      .title-glow {
        text-shadow: 2px 2px 0px #FFF, 0 0 10px #F06292;
      }
      
      /* Button Text Stroke Simulation */
      .btn-text-stroke {
        text-shadow: 1px 1px 0px rgba(160, 80, 0, 0.3);
      }

      /* Vinyl Record Texture */
      .vinyl-grooves {
        background: 
          repeating-radial-gradient(
            #111 0, 
            #111 2px, 
            #181818 3px, 
            #181818 4px
          );
      }
      .vinyl-shine {
        background: conic-gradient(
          rgba(255,255,255,0) 0%,
          rgba(255,255,255,0.05) 20%,
          rgba(255,255,255,0) 25%,
          rgba(255,255,255,0) 45%,
          rgba(255,255,255,0.08) 50%,
          rgba(255,255,255,0) 55%,
          rgba(255,255,255,0) 70%,
          rgba(255,255,255,0.05) 80%,
          rgba(255,255,255,0) 100%
        );
      }
      
      /* Lyrics Scroll Mask */
      .lyrics-mask {
        mask-image: linear-gradient(to bottom, transparent 0%, black 15%, black 85%, transparent 100%);
        -webkit-mask-image: linear-gradient(to bottom, transparent 0%, black 15%, black 85%, transparent 100%);
      }
    </style>
    
    <!-- Import Maps: Fixed to prevent version conflicts -->
    <script type="importmap">
    {
      "imports": {
        "react": "https://esm.sh/react@18.2.0",
        "react-dom": "https://esm.sh/react-dom@18.2.0",
        "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
        "framer-motion": "https://esm.sh/framer-motion@10.16.4?deps=react@18.2.0,react-dom@18.2.0",
        "lucide-react": "https://esm.sh/lucide-react@0.292.0?deps=react@18.2.0,react-dom@18.2.0",
        "three": "https://esm.sh/three@0.160.0",
        "three/addons/": "https://esm.sh/three@0.160.0/examples/jsm/",
        "gsap": "https://esm.sh/gsap@3.12.5",
        "canvas-confetti": "https://esm.sh/canvas-confetti@1.9.2",
        "html2canvas": "https://esm.sh/html2canvas@1.4.1"
      }
    }
    </script>
  </head>
  <body>
    <div id="root"></div>

    <!-- MAIN APP SCRIPT -->
    <script type="text/babel" data-presets="react,typescript" data-type="module">
      import React, { useState, useEffect, useRef, useMemo, useCallback } from 'react';
      import { createRoot } from 'react-dom/client';
      import { motion, AnimatePresence, useAnimation } from 'framer-motion';
      import { Volume2, VolumeX, ArrowLeft, X, ArrowRight, Camera, Mic, Flame, Wind, Hand, RefreshCw, XCircle, Heart, Sparkles, Download, Share2, PenTool, AlertCircle, User, Lock, Eye, EyeOff, MessageCircle, Bell, ChevronLeft, Disc, Music, Play, Pause, SkipBack, SkipForward, Cloud } from 'lucide-react';
      import * as THREE from 'three';
      import { OrbitControls } from 'three/addons/controls/OrbitControls.js';
      import gsap from 'gsap';
      import confetti from 'canvas-confetti';
      import html2canvas from 'html2canvas';

      // --- 1. CONSTANTS & ASSETS ---
      const RECIPIENT_NAME = "Â∞èÂè∂";
      const SENDER_NAME = "Â∞èÈ©¨"; // Changed from "Best Friend"
      
      // Fixed: Use a stable MP3 URL (Pachelbel's Canon) to prevent "no supported source" errors
      const AUDIO_URL = "https://ia800501.us.archive.org/11/items/pachelbel-canon-in-d/Pachelbel%27s%20Canon%20in%20D.mp3"; 
      
      const ASSETS = {
        balloons: [
          'https://test.fukit.cn/autoupload/f/IeSYb0Mnf1Z62nIKYGB4NyfNcKcqEnRmcljopnyJoMs/20251214/ID9X/4276X4224/balloon1.png/webp',
          'https://test.fukit.cn/autoupload/f/IeSYb0Mnf1Z62nIKYGB4NyfNcKcqEnRmcljopnyJoMs/20251214/SeRS/4320X4288/balloon2.png/webp',
          'https://test.fukit.cn/autoupload/f/IeSYb0Mnf1Z62nIKYGB4NyfNcKcqEnRmcljopnyJoMs/20251214/mzlX/4284X4252/balloon3.png/webp'
        ],
        giftImage: './images/usagi-surprise.png',
        loginBackground: 'https://xland.eu.org/autoupload/f/IeSYb0Mnf1Z62nIKYGB4NyfNcKcqEnRmcljopnyJoMs/20251211/js6e/1922X1074/background.jpg', 
        sounds: {
          // Fixed: Use a stable MP3 for better browser compatibility
          bgm: 'https://files.freemusicarchive.org/storage-freemusicarchive-org/music/ccCommunity/Kai_Engel/Satin/Kai_Engel_-_04_-_Sentinel.mp3',
        }
      };

      const BIRTHDAY_LETTER = `Á•ù‰Ω†ÁîüÊó•Âø´‰πêÔºÅ
      ÊÑø‰Ω†ÂÉè‰πåËê®Â•á‰∏ÄÊ†∑Êó†ÂøßÊó†ËôëÔºå
      Ë¢´Ê∏©ÊöñÂåÖÂõ¥Ôºå
      Êö¥ÂØå„ÄÅÂºÄÂøÉ„ÄÅÂÅ•Â∫∑ÔºÅ
      ÊâÄÊúâÁæéÂ•ΩÂ¶ÇÊúüËÄåËá≥~`;

      // Mock Lyrics Data
      const LYRICS = [
        { time: 0, text: "Wait for the music..." },
        { time: 2, text: "Happy Birthday, dear Xiao Ye" },
        { time: 6, text: "Another year has passed away" },
        { time: 10, text: "But you shine brighter every day" },
        { time: 14, text: "Like the sun in the month of May" },
        { time: 18, text: "May your dreams take flight and soar" },
        { time: 24, text: "Higher than they've been before" },
        { time: 30, text: "Happiness knocking at your door" },
        { time: 36, text: "Wishing you this and so much more" },
        { time: 42, text: "Stay happy, stay cute, stay you" },
        { time: 48, text: "All your wishes will come true" },
        { time: 54, text: "We love you! ‚ù§Ô∏è" },
        { time: 60, text: "..." },
        { time: 100, text: "..." },
      ];

      const PHOTOS = [
        { id: 1, url: 'https://picsum.photos/800/800?random=11', rotation: -3 },
        { id: 2, url: 'https://picsum.photos/800/800?random=12', rotation: 2 },
        { id: 3, url: 'https://picsum.photos/800/800?random=13', rotation: -1 },
        { id: 4, url: 'https://picsum.photos/800/800?random=14', rotation: 4 },
        { id: 5, url: 'https://picsum.photos/800/800?random=15', rotation: -2 },
        { id: 6, url: 'https://picsum.photos/800/800?random=16', rotation: 3 },
        { id: 7, url: 'https://picsum.photos/800/800?random=17', rotation: -4 },
        { id: 8, url: 'https://picsum.photos/800/800?random=18', rotation: 1 },
        { id: 9, url: 'https://picsum.photos/800/800?random=19', rotation: -2 }
      ];

      // --- 2. COMPONENTS ---

      // Light Overlay Component
      const LightOverlay = () => {
        const lights = useMemo(() => Array.from({ length: 6 }).map((_, i) => ({
          id: i,
          x: Math.random() * 100,
          y: Math.random() * 100,
          scale: Math.random() * 0.5 + 0.8,
          duration: Math.random() * 10 + 20,
        })), []);

        return (
          <div className="absolute inset-0 z-0 pointer-events-none overflow-hidden">
            {lights.map(l => (
              <motion.div
                key={l.id}
                className="absolute rounded-full bg-yellow-200/20 blur-[80px]"
                style={{
                  left: `${l.x}%`,
                  top: `${l.y}%`,
                  width: '40vw',
                  height: '40vw',
                }}
                animate={{
                  x: [0, 50, -50, 0],
                  y: [0, -50, 50, 0],
                  scale: [l.scale, l.scale * 1.2, l.scale]
                }}
                transition={{
                  duration: l.duration,
                  repeat: Infinity,
                  ease: "easeInOut"
                }}
              />
            ))}
          </div>
        );
      };

      // Scene Decorations (Grass & Clouds)
      const SceneDecorations = () => {
        return (
          <>
             {/* Clouds - Top Layer */}
             <div className="absolute top-0 w-full z-10 pointer-events-none opacity-80">
                <motion.div 
                   animate={{ x: [-20, 20, -20] }} 
                   transition={{ duration: 10, repeat: Infinity, ease: "easeInOut" }}
                   className="absolute top-10 left-10 text-white/40"
                >
                   <Cloud size={120} fill="currentColor" className="drop-shadow-lg" />
                </motion.div>
                <motion.div 
                   animate={{ x: [20, -20, 20] }} 
                   transition={{ duration: 15, repeat: Infinity, ease: "easeInOut" }}
                   className="absolute top-24 right-20 text-white/30"
                >
                   <Cloud size={90} fill="currentColor" className="drop-shadow-md" />
                </motion.div>
                <motion.div 
                   animate={{ x: [-10, 10, -10] }} 
                   transition={{ duration: 12, repeat: Infinity, ease: "easeInOut" }}
                   className="absolute top-5 left-1/2 text-white/20"
                >
                   <Cloud size={150} fill="currentColor" className="drop-shadow-xl" />
                </motion.div>
             </div>

             {/* Grass - Bottom Layer */}
             <div className="absolute bottom-0 w-full h-32 z-10 pointer-events-none opacity-60">
                <svg viewBox="0 0 1440 320" className="absolute bottom-0 w-full h-full text-green-700/20" preserveAspectRatio="none">
                   <path fill="currentColor" fillOpacity="1" d="M0,224L48,213.3C96,203,192,181,288,181.3C384,181,480,203,576,224C672,245,768,267,864,261.3C960,256,1056,224,1152,197.3C1248,171,1344,149,1392,138.7L1440,128L1440,320L1392,320C1344,320,1248,320,1152,320C1056,320,960,320,864,320C768,320,672,320,576,320C480,320,384,320,288,320C192,320,96,320,48,320L0,320Z"></path>
                </svg>
                <svg viewBox="0 0 1440 320" className="absolute bottom-0 w-full h-full text-green-500/30" preserveAspectRatio="none" style={{ transform: 'scaleX(-1)' }}>
                   <path fill="currentColor" fillOpacity="1" d="M0,192L48,208C96,224,192,256,288,245.3C384,235,480,181,576,170.7C672,160,768,192,864,208C960,224,1056,224,1152,202.7C1248,181,1344,139,1392,117.3L1440,96L1440,320L1392,320C1344,320,1248,320,1152,320C1056,320,960,320,864,320C768,320,672,320,576,320C480,320,384,320,288,320C192,320,96,320,48,320L0,320Z"></path>
                </svg>
             </div>
          </>
        );
      };

      // Mini Countdown Component
      const MiniCountdown = () => {
         return (
            <div className="absolute top-6 right-6 z-50 pointer-events-none">
               <motion.div 
                  initial={{ y: -50, opacity: 0 }}
                  animate={{ y: 0, opacity: 1 }}
                  transition={{ delay: 1, type: "spring" }}
                  className="bg-white/80 backdrop-blur-sm px-4 py-2 rounded-2xl shadow-lg border-2 border-usagi-orange/50 transform rotate-3"
               >
                  <span className="font-hand text-xl text-usagi-text font-bold">
                     Ë∑ùÁ¶ªÁîüÊó•ËøòÊúâ <span className="text-2xl text-usagi-orange">0</span> Â§©‚ú®
                  </span>
               </motion.div>
            </div>
         );
      };

      // Back Button
      const BackButton = ({ onClick, disabled = false }) => {
        const [isAnimating, setIsAnimating] = useState(false);

        const handleClick = (e) => {
          // Prevent potential event bubbling or default behaviors causing errors
          if (e && e.stopPropagation) e.stopPropagation();
          
          if (disabled || isAnimating) return;
          
          setIsAnimating(true);
          
          // Wait for the pull-down animation to perform before navigating
          setTimeout(() => {
             onClick();
             // Reset animation state shortly after navigation starts
             setTimeout(() => setIsAnimating(false), 200);
          }, 600);
        };

        return (
          <motion.div 
            className="fixed top-0 left-6 z-[60] flex flex-col items-center"
            initial={{ y: -200, opacity: 0 }} 
            animate={{ 
               y: disabled ? -200 : 0, 
               opacity: disabled ? 0 : 1,
               pointerEvents: disabled ? 'none' : 'auto'
            }} 
            transition={{ duration: 0.8, type: "spring", stiffness: 60 }}
          >
            {/* The String (Visual only) */}
            <div className="w-[1.5px] h-10 bg-[#8D6E63]/60 shadow-sm relative z-0 origin-top"></div>

            {/* The Sunny Doll Button */}
            <motion.div
               className="cursor-pointer relative z-10 -mt-1 origin-top"
               onClick={handleClick}
               whileHover={{ 
                  rotate: [0, -5, 5, 0], 
                  transition: { repeat: Infinity, duration: 3, ease: "easeInOut" } 
               }}
               animate={isAnimating ? { y: [0, 60, 0] } : { y: 0 }}
               transition={isAnimating ? { duration: 0.6, times: [0, 0.4, 1], ease: "easeInOut" } : {}}
            >
               <img 
                 src="https://test.fukit.cn/autoupload/f/IeSYb0Mnf1Z62nIKYGB4NyfNcKcqEnRmcljopnyJoMs/20251214/bzad/2768X2688/back.png/webp" 
                 alt="Back" 
                 className="w-20 md:w-24 object-contain filter drop-shadow-lg hover:brightness-105 transition-all" 
                 draggable="false"
               />
            </motion.div>
          </motion.div>
        );
      };

      // SceneVinylPlayer (Full Page)
      const SceneVinylPlayer = ({ onBack }) => {
        const [isPlaying, setIsPlaying] = useState(false);
        const [progress, setProgress] = useState(0);
        const [duration, setDuration] = useState(0);
        const [currentTime, setCurrentTime] = useState(0);
        const [volume, setVolume] = useState(0.5);
        
        const audioRef = useRef(null);
        const canvasRef = useRef(null);
        const analyserRef = useRef(null);
        const requestRef = useRef(null);
        const vinylRef = useRef(null);
        const lyricsContainerRef = useRef(null);

        // Audio Initialization
        useEffect(() => {
          const audio = new Audio(AUDIO_URL);
          audio.crossOrigin = "anonymous";
          audio.loop = true;
          audio.volume = volume;
          audioRef.current = audio;

          const AC = window.AudioContext || window.webkitAudioContext;
          const ctx = new AC();
          const analyser = ctx.createAnalyser();
          analyser.fftSize = 256; 
          
          const src = ctx.createMediaElementSource(audio);
          src.connect(analyser);
          analyser.connect(ctx.destination);
          analyserRef.current = analyser;

          const updateProgress = () => {
             setCurrentTime(audio.currentTime);
             setProgress((audio.currentTime / audio.duration) * 100 || 0);
          };
          
          audio.addEventListener('timeupdate', updateProgress);
          audio.addEventListener('loadedmetadata', () => setDuration(audio.duration));
          
          audio.play().then(() => setIsPlaying(true)).catch(console.error);

          return () => {
             audio.pause();
             audio.removeEventListener('timeupdate', updateProgress);
             ctx.close();
             cancelAnimationFrame(requestRef.current);
          };
        }, []);

        const togglePlay = () => {
           if(isPlaying) audioRef.current.pause();
           else audioRef.current.play();
           setIsPlaying(!isPlaying);
        };

        const handleVolumeChange = (e) => {
           const v = parseFloat(e.target.value);
           setVolume(v);
           if(audioRef.current) audioRef.current.volume = v;
        };

        const handleSeek = (e) => {
           const val = parseFloat(e.target.value);
           if(audioRef.current && duration) {
              audioRef.current.currentTime = (val / 100) * duration;
           }
        };

        const animate = () => {
          if (!canvasRef.current || !analyserRef.current) return;
          const canvas = canvasRef.current;
          const ctx = canvas.getContext('2d');
          const width = canvas.width;
          const height = canvas.height;
          const centerX = width / 2;
          const centerY = height / 2;
          const radius = Math.min(width, height) * 0.28; 

          const bufferLength = analyserRef.current.frequencyBinCount;
          const dataArray = new Uint8Array(bufferLength);
          analyserRef.current.getByteFrequencyData(dataArray);

          ctx.clearRect(0, 0, width, height);

          const bars = 60; 
          const step = (Math.PI * 2) / bars;

          for (let i = 0; i < bars; i++) {
             const dataIndex = Math.floor((i / bars) * (bufferLength * 0.7)); 
             const value = dataArray[dataIndex];
             const barHeight = Math.max(4, (value / 255) * 60); 
             
             const angle = i * step - Math.PI / 2; 

             const x1 = centerX + Math.cos(angle) * radius;
             const y1 = centerY + Math.sin(angle) * radius;
             const x2 = centerX + Math.cos(angle) * (radius + barHeight);
             const y2 = centerY + Math.sin(angle) * (radius + barHeight);

             ctx.beginPath();
             ctx.moveTo(x1, y1);
             ctx.lineTo(x2, y2);
             ctx.strokeStyle = `rgba(197, 160, 89, ${value / 255})`; 
             ctx.lineWidth = 3;
             ctx.lineCap = 'round';
             ctx.stroke();
          }

          requestRef.current = requestAnimationFrame(animate);
        };

        useEffect(() => {
           requestRef.current = requestAnimationFrame(animate);
           return () => cancelAnimationFrame(requestRef.current);
        }, []);

        useEffect(() => {
           const resize = () => {
              if(canvasRef.current) {
                 canvasRef.current.width = canvasRef.current.parentElement.offsetWidth;
                 canvasRef.current.height = canvasRef.current.parentElement.offsetHeight;
              }
           };
           window.addEventListener('resize', resize);
           resize();
           return () => window.removeEventListener('resize', resize);
        }, []);

        const currentLyricIndex = useMemo(() => {
           return LYRICS.findLastIndex(l => currentTime >= l.time);
        }, [currentTime]);

        useEffect(() => {
           if(lyricsContainerRef.current && currentLyricIndex !== -1) {
              const activeEl = lyricsContainerRef.current.children[currentLyricIndex];
              if(activeEl) {
                 activeEl.scrollIntoView({ behavior: 'smooth', block: 'center' });
              }
           }
        }, [currentLyricIndex]);

        const fmtTime = (t) => {
           if(!t) return "0:00";
           const m = Math.floor(t / 60);
           const s = Math.floor(t % 60).toString().padStart(2, '0');
           return `${m}:${s}`;
        };

        return (
          <motion.div 
            initial={{ opacity: 0 }}
            animate={{ opacity: 1 }}
            exit={{ opacity: 0 }}
            className="fixed inset-0 z-[60] bg-vinyl-bg flex flex-col md:flex-row overflow-hidden text-vinyl-text font-serif"
          >
             <button onClick={onBack} className="absolute top-6 left-6 z-50 p-2 rounded-full bg-white/5 hover:bg-white/10 transition-colors border border-white/10 text-vinyl-text">
                <ChevronLeft size={24} />
             </button>

             <div className="relative flex-1 h-[60%] md:h-full flex flex-col items-center justify-center p-8">
                <div className="absolute inset-0 bg-[radial-gradient(circle_at_center,_var(--tw-gradient-stops))] from-vinyl-bg via-[#120f0b] to-black opacity-80 pointer-events-none"></div>
                
                <div className="md:hidden absolute top-4 text-center z-10">
                   <h2 className="text-xl font-bold tracking-widest text-vinyl-gold">A THOUSAND YEARS</h2>
                   <p className="text-xs text-white/40 tracking-[0.2em] mt-1">CHRIST</p>
                </div>

                <div className="relative w-full max-w-[500px] aspect-square flex items-center justify-center">
                   <canvas ref={canvasRef} className="absolute inset-0 z-0 opacity-80" />

                   <motion.div 
                      ref={vinylRef}
                      className="w-[65%] h-[65%] rounded-full shadow-2xl relative z-10 border border-[#222]"
                      style={{ 
                         background: 'radial-gradient(#111 20%, #1a1a1a 60%, #000 70%)',
                         boxShadow: '0 0 50px rgba(0,0,0,0.8)' 
                      }}
                      animate={{ rotate: 360 }}
                      transition={{ duration: isPlaying ? 4 : 0, ease: "linear", repeat: Infinity }}
                   >
                      <div className="absolute inset-[2%] rounded-full vinyl-grooves opacity-80 border border-white/5"></div>
                      <div className="absolute inset-0 rounded-full vinyl-shine opacity-30"></div>
                      
                      <div className="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-[35%] h-[35%] rounded-full bg-[#8B0000] border-4 border-[#1a1510] flex items-center justify-center shadow-inner">
                         <div className="text-center transform scale-75">
                            <div className="text-[8px] text-vinyl-gold tracking-widest uppercase mb-1">High Fidelity</div>
                            <div className="text-2xl">üéª</div>
                         </div>
                         <div className="absolute w-2 h-2 bg-black rounded-full shadow-[0_1px_1px_rgba(255,255,255,0.2)]"></div>
                      </div>
                   </motion.div>

                   <motion.div 
                      className="absolute top-[5%] right-[5%] w-[80px] h-[250px] z-20 pointer-events-none origin-[top_right]"
                      animate={{ rotate: isPlaying ? 25 : 0 }}
                      initial={{ rotate: 0 }}
                      transition={{ duration: 1, ease: "easeInOut" }}
                   >
                       <img src="https://cdn-icons-png.flaticon.com/512/3062/3062634.png" className="w-full h-full object-contain opacity-0" alt="arm" /> 
                       <div className="absolute top-4 right-4 w-16 h-16 bg-[#222] rounded-full shadow-lg border border-white/10 flex items-center justify-center">
                          <div className="w-8 h-8 rounded-full bg-[#111] shadow-inner"></div>
                       </div>
                       <div className="absolute top-10 right-10 w-2 h-48 bg-[#444] rounded-full origin-top transform rotate-[15deg] shadow-xl" style={{ background: 'linear-gradient(90deg, #333, #666, #333)' }}></div>
                       <div className="absolute bottom-[20px] right-[75px] w-12 h-20 bg-[#222] rounded-md transform rotate-[35deg] shadow-lg"></div>
                   </motion.div>
                </div>
                
                <div className="absolute bottom-8 z-30 flex flex-col items-center gap-4 w-full px-8 md:px-0 md:w-auto">
                    <div className="flex items-center gap-6">
                       <button className="text-vinyl-goldDim hover:text-vinyl-gold transition-colors"><SkipBack size={20} fill="currentColor" /></button>
                       <button onClick={togglePlay} className="w-14 h-14 rounded-full bg-vinyl-gold text-vinyl-bg flex items-center justify-center hover:bg-[#d4b06a] transition-colors shadow-gold-glow">
                          {isPlaying ? <Pause size={24} fill="currentColor" /> : <Play size={24} fill="currentColor" className="ml-1" />}
                       </button>
                       <button className="text-vinyl-goldDim hover:text-vinyl-gold transition-colors"><SkipForward size={20} fill="currentColor" /></button>
                    </div>
                    
                    <div className="flex items-center gap-3 w-full max-w-xs">
                        <span className="text-xs text-white/40 font-sans tabular-nums w-8 text-right">{fmtTime(currentTime)}</span>
                        <input 
                           type="range" 
                           min="0" max="100" 
                           value={progress}
                           onChange={handleSeek}
                           className="flex-1 h-1 bg-white/10 rounded-lg appearance-none cursor-pointer [&::-webkit-slider-thumb]:appearance-none [&::-webkit-slider-thumb]:w-3 [&::-webkit-slider-thumb]:h-3 [&::-webkit-slider-thumb]:bg-vinyl-gold [&::-webkit-slider-thumb]:rounded-full"
                        />
                        <span className="text-xs text-white/40 font-sans tabular-nums w-8">{fmtTime(duration)}</span>
                    </div>
                    
                    <div className="flex items-center gap-2 mt-1">
                        <Volume2 size={12} className="text-white/30" />
                        <input type="range" min="0" max="1" step="0.01" value={volume} onChange={handleVolumeChange} className="w-20 h-1 bg-white/10 rounded-lg appearance-none cursor-pointer [&::-webkit-slider-thumb]:appearance-none [&::-webkit-slider-thumb]:w-2 [&::-webkit-slider-thumb]:h-2 [&::-webkit-slider-thumb]:bg-white/50 [&::-webkit-slider-thumb]:rounded-full" />
                    </div>
                </div>
             </div>

             <div className="w-full h-[40%] md:h-full md:w-[40%] bg-[#15120e] relative flex flex-col items-center pt-8 md:pt-20 pb-8 px-6 border-l border-white/5">
                <div className="hidden md:block text-center mb-12">
                   <h2 className="text-2xl font-bold tracking-[0.2em] text-vinyl-gold mb-2 font-serif uppercase">A Thousand Years</h2>
                   <p className="text-xs text-white/40 tracking-[0.3em] font-sans">PLAYBACK ACTIVE</p>
                </div>
                
                <div className="relative w-full h-full overflow-hidden lyrics-mask">
                   <div 
                      ref={lyricsContainerRef}
                      className="w-full h-full overflow-y-auto scrollbar-hide flex flex-col items-center py-[50%]"
                   >
                      {LYRICS.map((line, i) => {
                         const isActive = i === currentLyricIndex;
                         return (
                            <motion.div 
                               key={i}
                               className={`text-center py-3 md:py-4 transition-all duration-500 cursor-pointer ${isActive ? 'text-vinyl-gold scale-105 opacity-100 font-medium' : 'text-white/30 scale-100 opacity-40 blur-[0.5px] hover:opacity-60'}`}
                               onClick={() => {
                                  if(audioRef.current) audioRef.current.currentTime = line.time;
                               }}
                            >
                               <p className="text-lg md:text-xl font-serif leading-relaxed px-4">
                                  {line.text}
                               </p>
                            </motion.div>
                         )
                      })}
                      <div className="h-32"></div> 
                   </div>
                </div>
             </div>
          </motion.div>
        );
      };

      // SCENE 0: LOGIN
      const Scene0Login = ({ onLogin }) => {
        const [showPassword, setShowPassword] = useState(false);
        const [username, setUsername] = useState('');
        const [password, setPassword] = useState('');
        const [error, setError] = useState('');
        const [shake, setShake] = useState(false);

        const handleLogin = (e) => {
          e.preventDefault();
          if (username === 'xiaoma' && password === '1227') {
            setError('');
            onLogin();
          } else {
            setError('Ë¥¶Âè∑ÊàñÂØÜÁ†ÅÈîôËØØÔºåËØ∑ÈáçËØï');
            setShake(true);
            setTimeout(() => setShake(false), 500);
          }
        };

        return (
          <motion.div 
            className="fixed inset-0 z-50 flex items-center justify-center bg-cover bg-center overflow-hidden"
            style={{ backgroundImage: `url(${ASSETS.loginBackground})` }}
            initial={{ opacity: 0 }}
            animate={{ opacity: 1 }}
            exit={{ opacity: 0, scale: 1.1 }}
            transition={{ duration: 0.8 }}
          >
            <div className="absolute inset-0 bg-black/20 backdrop-blur-[1px]"></div>

            <motion.div 
              className="glass-card w-[90%] max-w-[400px] rounded-2xl p-8 relative z-10 flex flex-col items-center"
              initial={{ y: 50, opacity: 0 }}
              animate={shake ? { x: [-10, 10, -10, 10, 0] } : { y: 0, opacity: 1 }}
              transition={shake ? { duration: 0.4 } : { delay: 0.2, type: "spring", stiffness: 50 }}
            >
              <h2 className="text-3xl font-bold text-white mb-2 tracking-wide drop-shadow-md">Ê¨¢ËøéÂõûÊù•</h2>
              <p className="text-white/80 text-sm mb-6">ËØ∑ÁôªÂΩïÊÇ®ÁöÑË¥¶Êà∑</p>

              <form onSubmit={handleLogin} className="w-full space-y-4">
                <div className="relative group">
                  <div className="absolute left-4 top-1/2 -translate-y-1/2 text-gray-500 transition-colors group-focus-within:text-usagi-orange">
                    <User size={20} />
                  </div>
                  <input 
                    type="text" 
                    value={username}
                    onChange={(e) => setUsername(e.target.value)}
                    placeholder="Â∞è‰∏ªÔºåËØ∑Ëµê‰∏™Áî®Êà∑Âêç" 
                    className="w-full py-3.5 pl-12 pr-4 rounded-2xl bg-white/80 border-none outline-none focus:bg-white focus:ring-2 focus:ring-usagi-orange/50 transition-all placeholder:text-gray-500 text-gray-700"
                  />
                </div>

                <div className="relative group">
                  <div className="absolute left-4 top-1/2 -translate-y-1/2 text-gray-500 transition-colors group-focus-within:text-usagi-orange">
                    <Lock size={20} />
                  </div>
                  <input 
                    type={showPassword ? "text" : "password"} 
                    value={password}
                    onChange={(e) => setPassword(e.target.value)}
                    placeholder="Â∞è‰∏ªÁöÑÈÄöÂÖ≥ÂØÜ‰ª§" 
                    className="w-full py-3.5 pl-12 pr-12 rounded-2xl bg-white/80 border-none outline-none focus:bg-white focus:ring-2 focus:ring-usagi-orange/50 transition-all placeholder:text-gray-500 text-gray-700"
                  />
                  <button 
                    type="button"
                    onClick={() => setShowPassword(!showPassword)}
                    className="absolute right-4 top-1/2 -translate-y-1/2 text-gray-400 hover:text-gray-600 focus:outline-none"
                  >
                    {showPassword ? <EyeOff size={20} /> : <Eye size={20} />}
                  </button>
                </div>

                {error && (
                  <motion.div initial={{ opacity: 0, height: 0 }} animate={{ opacity: 1, height: 'auto' }} className="text-red-200 bg-red-500/30 px-3 py-1 rounded-2xl text-xs text-center font-bold">
                    {error}
                  </motion.div>
                )}

                <div className="flex justify-between items-center text-xs text-white/90 px-1">
                  <label className="flex items-center gap-2 cursor-pointer hover:text-white transition-colors">
                    <input type="checkbox" className="w-4 h-4 rounded border-gray-300 text-usagi-orange focus:ring-usagi-orange" />
                    <span>ËÆ∞‰ΩèÊàë</span>
                  </label>
                  <button type="button" className="hover:underline hover:text-white transition-colors">ÂøòËÆ∞ÂØÜÁ†Å?</button>
                </div>

                <button 
                  type="submit"
                  className="w-full py-3.5 rounded-2xl bg-gradient-to-r from-[#8A7CFB] to-[#635BFF] text-white font-bold text-lg shadow-lg hover:shadow-xl hover:opacity-90 active:scale-[0.98] transition-all mt-4"
                >
                  Â∞è‰∏ªËØ∑Ëøõ
                </button>
              </form>

              <div className="w-full flex items-center gap-4 my-6 text-white/60 text-xs">
                <div className="h-px bg-white/30 flex-1"></div>
                <span>ÊàñËÄÖ</span>
                <div className="h-px bg-white/30 flex-1"></div>
              </div>

              <div className="w-full space-y-3">
                <button className="w-full py-2.5 rounded-2xl bg-white/90 hover:bg-white text-[#07C160] font-bold border border-[#07C160]/20 flex items-center justify-center gap-2 transition-all shadow-sm">
                  <MessageCircle size={20} fill="currentColor" className="text-[#07C160]" />
                  <span>‰ΩøÁî®ÂæÆ‰ø°ÁôªÂΩï</span>
                </button>
                <button className="w-full py-2.5 rounded-2xl bg-white/90 hover:bg-white text-[#0099FF] font-bold border border-[#0099FF]/20 flex items-center justify-center gap-2 transition-all shadow-sm">
                  <Bell size={20} fill="currentColor" className="text-[#0099FF]" />
                  <span>‰ΩøÁî®QQÁôªÂΩï</span>
                </button>
              </div>

              <div className="mt-8 text-xs text-white/80">
                ËøòÊ≤°ÊúâË¥¶Êà∑? <button className="text-blue-200 font-bold hover:underline ml-1">Á´ãÂç≥Ê≥®ÂÜå</button>
              </div>

            </motion.div>
          </motion.div>
        );
      };

      // Usagi Character Component
      const UsagiCharacter = ({ action, className, onClick, boardText }) => {
        const variants = {
          idle: { y: [0, -5, 0], transition: { repeat: Infinity, duration: 2 } },
          jump: { y: [0, -50, 0], scale: [1, 1.1, 0.9, 1], transition: { repeat: Infinity, duration: 0.6 } },
          wave: { rotate: [0, 10, -10, 0], transition: { repeat: Infinity, duration: 1 } },
          camera: { scale: [1, 1.05, 1], transition: { duration: 0.3 } },
          cheer: { y: [0, -20, 0], transition: { repeat: Infinity, duration: 0.4 } },
          shhh: { scale: 1 },
          'hold-board': { y: [0, -3, 0], transition: { repeat: Infinity, duration: 3 } },
          heart: { scale: [1, 1.1, 1], transition: { duration: 0.5, repeat: Infinity, repeatDelay: 1 } }
        };

        return (
          <motion.div 
            className={`relative cursor-pointer select-none ${className}`}
            onClick={onClick}
            animate={action}
            variants={variants}
            whileHover={{ scale: 1.05 }}
            whileTap={{ scale: 0.95 }}
          >
            <img 
              src="https://test.fukit.cn/autoupload/f/IeSYb0Mnf1Z62nIKYGB4NyfNcKcqEnRmcljopnyJoMs/20251214/P3yB/4272X4300/mai.png/webp" 
              alt="Character" 
              className="w-full h-full object-contain drop-shadow-lg pointer-events-none"
              draggable="false"
            />
            
            {action === 'heart' && (
                <motion.div 
                  className="absolute -top-4 -right-4 text-4xl filter drop-shadow-md"
                  initial={{ scale: 0, opacity: 0 }}
                  animate={{ scale: [1, 1.2, 1], opacity: 1 }}
                  transition={{ duration: 0.8, repeat: Infinity }}
                >
                  ‚ù§Ô∏è
                </motion.div>
            )}

            {action === 'camera' && (
                <motion.div 
                  className="absolute bottom-0 right-0 text-3xl filter drop-shadow-md"
                  initial={{ opacity: 0 }}
                  animate={{ opacity: 1 }}
                >
                  üì∑
                </motion.div>
            )}
            
            {action === 'hold-board' && (
               <div className="absolute top-[55%] left-1/2 -translate-x-1/2 -translate-y-1/2 w-[110%] h-[40%] max-w-[300px]">
                  <div className="w-full h-full bg-white border-4 border-dashed border-usagi-orange rounded-xl flex items-center justify-center p-3 shadow-lg transform -rotate-2 relative z-10">
                      <div className="text-sm md:text-xl text-center font-hand text-usagi-text leading-tight break-words w-full h-full flex items-center justify-center">
                          {boardText || "Happy Birthday!"}
                      </div>
                  </div>
               </div>
            )}
          </motion.div>
        );
      };

      // Background Component
      const Background = () => {
        const [mousePosition, setMousePosition] = useState({ x: 0, y: 0 });
        useEffect(() => {
          const handleMouseMove = (e) => setMousePosition({ x: e.clientX, y: e.clientY });
          window.addEventListener('mousemove', handleMouseMove);
          return () => window.removeEventListener('mousemove', handleMouseMove);
        }, []);
        return (
          <div className="fixed inset-0 z-0 overflow-hidden bg-gradient-to-b from-[#FFF9E6] to-[#F9D59B] pointer-events-none">
            <motion.div initial={{ x: -100 }} animate={{ x: '100vw' }} transition={{ duration: 35, repeat: Infinity, ease: 'linear' }} className="absolute top-10 left-0 text-white opacity-60 text-9xl blur-sm">‚òÅÔ∏è</motion.div>
            {Array.from({ length: 20 }).map((_, i) => (
              <motion.div key={i} className="absolute rounded-full bg-[#FBBF77] shadow-[0_0_10px_#FBBF77]"
                style={{ width: Math.random() * 8 + 4, height: Math.random() * 8 + 4, top: `${Math.random() * 100}%`, left: `${Math.random() * 100}%`, x: (mousePosition.x * 0.02 * (i % 2 === 0 ? 1 : -1)), y: (mousePosition.y * 0.02 * (i % 2 === 0 ? 1 : -1)) }}
                animate={{ opacity: [0.4, 1, 0.4], scale: [1, 1.2, 1] }} transition={{ duration: 1, repeat: Infinity, delay: Math.random() * 2 }}
              />
            ))}
          </div>
        );
      };

      // Atmosphere Particles
      const AtmosphereParticles = () => {
        const particles = useMemo(() => Array.from({ length: 15 }).map((_, i) => ({
          id: i,
          x: Math.random() * 100,
          y: Math.random() * 100,
          size: Math.random() * 10 + 5,
          color: ['#FFCdd2', '#FFF9C4', '#B2DFDB'][Math.floor(Math.random() * 3)],
          duration: Math.random() * 10 + 10,
          delay: Math.random() * 5
        })), []);

        return (
          <div className="absolute inset-0 pointer-events-none overflow-hidden z-0">
            {particles.map((p) => (
              <motion.div
                key={p.id}
                className="absolute rounded-full opacity-30"
                style={{
                  left: `${p.x}%`,
                  top: -20,
                  width: p.size,
                  height: p.size,
                  backgroundColor: p.color,
                  boxShadow: `0 0 10px ${p.color}`
                }}
                animate={{
                  y: ['0vh', '100vh'],
                  x: [0, Math.random() * 50 - 25],
                  rotate: [0, 360]
                }}
                transition={{
                  duration: p.duration,
                  repeat: Infinity,
                  ease: "linear",
                  delay: p.delay
                }}
              />
            ))}
          </div>
        );
      };

      // --- 3. SCENES ---

      // SCENE 1: Intro (UPDATED WITH BALLOON PHYSICS & BUTTON STYLE)
      const Scene1Intro = ({ onStart }) => {
        const BALLOON_TEXTS = ["ÂñúÊ¨¢‰Ω†~", "Ë¶ÅÂºÄÂøÉÔºÅ", "Êö¥ÂØåÊö¥ÂØå‚ú®", "Â§©Â§©Â•ΩÂøÉÊÉÖ", "ÂêÉ‰∏çËÉñÔºÅ", "Ê∞∏ËøúÁæéÂ∞ëÂ•≥", "Âπ≥ÂÆâÂñú‰πê", "Â•ΩËøêËøûËøû"];
        
        // Define specific colors for balloons based on index/assumed image content
        // 0: Pink/Red, 1: Blue/Teal, 2: Yellow/Orange
        const BALLOON_COLORS = [
           { shadow: 'rgba(255, 182, 193, 0.4)', filter: 'drop-shadow(0 15px 10px rgba(255, 105, 180, 0.2))' }, 
           { shadow: 'rgba(173, 216, 230, 0.4)', filter: 'drop-shadow(0 15px 10px rgba(70, 130, 180, 0.2))' }, 
           { shadow: 'rgba(255, 222, 173, 0.4)', filter: 'drop-shadow(0 15px 10px rgba(255, 165, 0, 0.2))' }
        ];

        const balloons = useMemo(() => {
          return Array.from({ length: 15 }).map((_, i) => {
            const scale = Math.random() * 0.4 + 0.8;
            const speed = Math.random() * 10 + 15;
            const sway = Math.random() * 50 + 30; // Amplitude
            const swayTime = Math.random() * 4 + 4; // Duration of one sway cycle
            
            return {
              id: i,
              src: ASSETS.balloons[i % ASSETS.balloons.length],
              colorConfig: BALLOON_COLORS[i % BALLOON_COLORS.length],
              left: Math.random() * 90 + 5,
              scale: scale,
              duration: speed,
              delay: Math.random() * 12,
              swayAmount: sway,
              swayDuration: swayTime,
              rotateAmount: Math.random() * 10 + 5
            };
          });
        }, []);

        // Interactive Balloon Sub-component with Enhanced Physics & Shadows
        const InteractiveBalloon = ({ config }) => {
          const [isClicked, setIsClicked] = useState(false);
          const [message, setMessage] = useState(null);

          const handleClick = (e) => {
            e.stopPropagation();
            setIsClicked(true);
            setMessage(BALLOON_TEXTS[Math.floor(Math.random() * BALLOON_TEXTS.length)]);
            
            setTimeout(() => setIsClicked(false), 300);
            setTimeout(() => setMessage(null), 1500);
          };

          return (
            <motion.div
              className="absolute"
              style={{ left: `${config.left}%`, bottom: '-150px', zIndex: 15 }}
              animate={{ 
                y: -window.innerHeight - 300,
                x: [0, config.swayAmount, -config.swayAmount/2, config.swayAmount/2, 0] // Natural wandering path
              }}
              transition={{ 
                y: { duration: config.duration, ease: "linear", repeat: Infinity, delay: config.delay }, 
                x: { duration: config.swayDuration, ease: "easeInOut", repeat: Infinity, repeatType: "mirror" }
              }}
            >
              <motion.div
                onClick={handleClick}
                // Simulate "bouncing off clouds" turbulence at the top (simple random x offset)
                style={{ filter: config.colorConfig.filter }}
                animate={isClicked ? { scale: 1.2, rotate: [0, -10, 10, 0] } : { 
                  scale: config.scale, 
                  rotate: [0, config.rotateAmount, 0, -config.rotateAmount, 0],
                  y: [0, -15, 0], // Internal bobbing for extra floatiness
                  x: [0, Math.random() * 10 - 5, 0] // Subtle turbulence
                }}
                transition={isClicked ? { duration: 0.3 } : { 
                  rotate: { duration: config.swayDuration - 1, ease: "easeInOut", repeat: Infinity },
                  y: { duration: 3, ease: "easeInOut", repeat: Infinity },
                  x: { duration: 5, ease: "easeInOut", repeat: Infinity, delay: Math.random() * 5 }
                }}
                className="relative cursor-pointer select-none"
                whileHover={{ scale: 1.1 }}
              >
                <img src={config.src} className="w-[100px] object-contain opacity-90" alt="balloon" draggable="false"/>
                
                {/* Colored Shadow Trail / Glow */}
                <div 
                   className="absolute bottom-2 left-1/2 -translate-x-1/2 w-3/4 h-4 rounded-full blur-md opacity-40 pointer-events-none"
                   style={{ background: config.colorConfig.shadow }}
                ></div>

                <AnimatePresence>
                  {message && (
                    <motion.div
                      initial={{ opacity: 0, scale: 0, y: 10 }}
                      animate={{ opacity: 1, scale: 1, y: -50 }}
                      exit={{ opacity: 0, scale: 0.5, y: -70 }}
                      transition={{ duration: 0.3 }}
                      className="absolute left-1/2 -translate-x-1/2 top-0 bg-white/95 px-3 py-1.5 rounded-xl text-usagi-text text-sm font-bold shadow-lg border-2 border-usagi-pink/50 whitespace-nowrap z-50 pointer-events-none"
                    >
                      {message}
                      <div className="absolute -bottom-1.5 left-1/2 -translate-x-1/2 w-3 h-3 bg-white/95 rotate-45 border-b-2 border-r-2 border-usagi-pink/50"></div>
                    </motion.div>
                  )}
                </AnimatePresence>
              </motion.div>
            </motion.div>
          );
        };

        return (
          <motion.div className="relative w-full h-screen flex flex-col items-center justify-center z-10 overflow-hidden" exit={{ opacity: 0, x: -50 }}>
            {/* Dynamic Light Background */}
            <LightOverlay />
            
