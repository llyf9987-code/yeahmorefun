<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Happy Birthday Xiao Ye! | Usagi Wishes</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Fredoka:wght@300;400;500;600&family=Zeyada&family=ZCOOL+KuaiLe&family=Playfair+Display:ital,wght@0,400;0,700;1,400&family=Henny+Penny&family=Chewy&display=swap" rel="stylesheet">
    
    <!-- MediaPipe Hands -->
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands@0.4.1646424915/hands.js" crossorigin="anonymous"></script>
    
    <!-- Babel for in-browser compilation -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <!-- PageFlip Library -->
    <script src="https://cdn.jsdelivr.net/npm/page-flip@2.0.7/dist/js/page-flip.browser.min.js"></script>

    <script>
      tailwind.config = {
        theme: {
          extend: {
            colors: {
              usagi: {
                main: '#F9D59B', orange: '#FBBF77', gold: '#F8C860',
                pink: '#F8C8DC', text: '#5D4037', light: '#FFFBE6', hover: '#F7C070',
                cream: '#FFF9E6', wood: '#8D6E63', woodDark: '#5D4037'
              },
              vinyl: {
                bg: '#1a1a1a', 
                gold: '#d4af37',
                goldDim: '#8a7224',
                text: '#e8dcc5',
                black: '#121212',
                groove: '#1f1f1f'
              }
            },
            fontFamily: {
              sans: ['Fredoka', 'sans-serif'],
              hand: ['Zeyada', 'cursive'],
              cute: ['"ZCOOL KuaiLe"', 'cursive'],
              serif: ['"Playfair Display"', 'serif'],
              magic: ['"Henny Penny"', 'cursive'],
              creamy: ['"Chewy"', 'cursive'],
            },
            animation: {
              'float': 'float 3s ease-in-out infinite',
              'bounce-slow': 'bounce 2s infinite',
              'drift': 'drift 10s linear infinite',
              'spin-slow': 'spin 8s linear infinite',
              'spin-vinyl': 'spin 1.8s linear infinite',
              'pulse-slow': 'pulse 4s cubic-bezier(0.4, 0, 0.6, 1) infinite',
              'sway': 'sway 2s ease-in-out infinite',
              'wobble': 'wobble 3s ease-in-out infinite',
            },
            keyframes: {
              float: { '0%, 100%': { transform: 'translateY(0)' }, '50%': { transform: 'translateY(-10px)' } },
              drift: { '0%': { transform: 'translateY(0) rotate(0deg)', opacity: '0' }, '50%': { opacity: '0.5' }, '100%': { transform: 'translateY(100px) rotate(180deg)', opacity: '0' } },
              sway: { '0%, 100%': { transform: 'rotate(-10deg)' }, '50%': { transform: 'rotate(10deg)' } },
              wobble: { '0%, 100%': { transform: 'rotate(-3deg) translateX(-2px)' }, '50%': { transform: 'rotate(3deg) translateX(2px)' } }
            },
            boxShadow: {
              'soft': '0 8px 32px rgba(93, 64, 55, 0.15)',
              'glow': '0 0 15px rgba(240, 98, 146, 0.5)',
              'vinyl': '0 20px 50px rgba(0,0,0,0.8), inset 0 0 0 2px #333',
              'gold-glow': '0 0 20px rgba(212, 175, 55, 0.4)',
              'wood': 'inset 0 0 60px rgba(0,0,0,0.5)',
              'sticker': '0 4px 0 rgba(0,0,0,0.1), 0 10px 10px rgba(0,0,0,0.1)',
              'plush': '0 0 0 4px rgba(255,183,77,0.3), 0 0 20px rgba(255,167,38,0.4)',
              'btn-plush': '0 4px 0 #FF8A65, 0 8px 10px rgba(0,0,0,0.2)',
              'btn-plush-active': '0 0 0 #FF8A65, inset 0 2px 5px rgba(0,0,0,0.1)',
            },
            backgroundImage: {
              'wood-pattern': "url('https://www.transparenttextures.com/patterns/wood-pattern.png')",
              'vinyl-grooves': "repeating-radial-gradient(#111 0, #111 2px, #222 3px, #222 4px)",
              'scratched': "url('https://www.transparenttextures.com/patterns/stardust.png')",
              'clouds': "url('https://www.transparenttextures.com/patterns/clouds.png')" 
            }
          }
        }
      }
    </script>
    <style>
      html, body { 
        background-color: #FFFDE7; 
        overflow-x: hidden; 
        cursor: url('https://test.fukit.cn/autoupload/f/IeSYb0Mnf1Z62nIKYGB4NyfNcKcqEnRmcljopnyJoMs/20251214/B4LO/32X33/usagi-cursor.png/webp') 0 0, auto !important;
      }
      
      .scrollbar-hide::-webkit-scrollbar { display: none; }
      .mirror-x { transform: scaleX(-1); }
      
      /* Refined Glassmorphism */
      .glass-card {
        background: rgba(0, 0, 0, 0.25);
        backdrop-filter: blur(10px);
        -webkit-backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 255, 255, 0.15);
        box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.3);
      }

      .title-glow {
        text-shadow: 2px 2px 0px #FFF, 0 0 10px #F06292;
      }
      
      .btn-text-stroke {
        text-shadow: 1px 1px 0px rgba(160, 80, 0, 0.3);
      }

      /* Specific Vinyl Styles */
      .vinyl-record {
        background: radial-gradient(circle at center, #050505 0%, #1a1a1a 25%, #050505 26%, #1a1a1a 27%, #0a0a0a 100%);
        box-shadow: inset 0 0 0 1px #333, 0 10px 20px rgba(0,0,0,0.6);
      }
      .grooves {
        background: repeating-radial-gradient(
          #0a0a0a 0, 
          #0a0a0a 2px, 
          #1f1f1f 3px, 
          #1f1f1f 4px
        );
        opacity: 0.8;
      }
      .arm-shadow {
        filter: drop-shadow(4px 4px 6px rgba(0,0,0,0.6));
      }
      
      /* Range Slider Customization */
      input[type=range] {
         -webkit-appearance: none;
         background: transparent;
      }
      input[type=range]::-webkit-slider-thumb {
         -webkit-appearance: none;
         height: 12px;
         width: 12px;
         border-radius: 50%;
         background: #d4af37;
         cursor: pointer;
         margin-top: -4px;
         box-shadow: 0 0 5px rgba(212, 175, 55, 0.5);
      }
      input[type=range]::-webkit-slider-runnable-track {
         width: 100%;
         height: 4px;
         cursor: pointer;
         background: rgba(255,255,255,0.2);
         border-radius: 2px;
      }

      /* Washi Tape CSS */
      .washi-tape {
        background-color: rgba(255, 255, 255, 0.4);
        background-image: linear-gradient(45deg, rgba(255,255,255,0.2) 25%, transparent 25%, transparent 50%, rgba(255,255,255,0.2) 50%, rgba(255,255,255,0.2) 75%, transparent 75%, transparent);
        background-size: 10px 10px;
        box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        backdrop-filter: blur(2px);
      }

      /* Pumpkin Bubble Shape */
      .pumpkin-bubble {
        background-color: #FFF3E0;
        border-radius: 40% 40% 45% 45% / 50% 50% 40% 40%;
        box-shadow: inset 0 0 30px rgba(255, 204, 128, 0.5), 0 0 0 6px rgba(255, 224, 178, 0.6), 0 10px 20px rgba(239, 108, 0, 0.15);
        position: relative;
      }
      .pumpkin-bubble::before {
        content: '';
        position: absolute;
        top: 0; left: 0; right: 0; bottom: 0;
        border-radius: inherit;
        box-shadow: inset 0 0 10px 2px rgba(255, 255, 255, 0.8);
        pointer-events: none;
      }
    </style>
    
    <script type="importmap">
    {
      "imports": {
        "react": "https://esm.sh/react@18.2.0",
        "react-dom": "https://esm.sh/react-dom@18.2.0",
        "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
        "framer-motion": "https://esm.sh/framer-motion@10.16.4?deps=react@18.2.0,react-dom@18.2.0",
        "lucide-react": "https://esm.sh/lucide-react@0.292.0?deps=react@18.2.0,react-dom@18.2.0",
        "three": "https://esm.sh/three@0.160.0",
        "three/addons/": "https://esm.sh/three@0.160.0/examples/jsm/",
        "gsap": "https://esm.sh/gsap@3.12.5",
        "canvas-confetti": "https://esm.sh/canvas-confetti@1.9.2",
        "html2canvas": "https://esm.sh/html2canvas@1.4.1"
      }
    }
    </script>
  </head>
  <body>
    <div id="root"></div>

    <script type="text/babel" data-presets="react,typescript" data-type="module">
      import React, { useState, useEffect, useRef, useMemo, useCallback } from 'react';
      import { createRoot } from 'react-dom/client';
      import { motion, AnimatePresence, useAnimation } from 'framer-motion';
      import { Volume2, VolumeX, ArrowLeft, X, ArrowRight, Camera, Mic, Flame, Wind, Hand, RefreshCw, XCircle, Heart, Sparkles, Download, Share2, PenTool, AlertCircle, User, Lock, Eye, EyeOff, MessageCircle, Bell, ChevronLeft, ChevronRight, Disc, Music, Play, Pause, SkipBack, SkipForward, Cloud, Upload, Grid, ImageIcon, Star, Wand2 } from 'lucide-react';
      import * as THREE from 'three';
      import { OrbitControls } from 'three/addons/controls/OrbitControls.js';
      import gsap from 'gsap';
      import confetti from 'canvas-confetti';
      import html2canvas from 'html2canvas';

      // --- 1. CONSTANTS & ASSETS ---
      const RECIPIENT_NAME = "Â∞èÂè∂";
      const SENDER_NAME = "Â∞èÈ©¨"; 
      
      const BGM_URL = 'https://audio.fukit.cn/autoupload/f/IeSYb0Mnf1Z62nIKYGB4NyfNcKcqEnRmcljopnyJoMs/20251215/tju5/7a2ac1e3fd83618b119afa5b1aaf0c2b.mp3';

      const ASSETS = {
        balloons: [
          'https://test.fukit.cn/autoupload/f/IeSYb0Mnf1Z62nIKYGB4NyfNcKcqEnRmcljopnyJoMs/20251214/ID9X/4276X4224/balloon1.png/webp',
          'https://test.fukit.cn/autoupload/f/IeSYb0Mnf1Z62nIKYGB4NyfNcKcqEnRmcljopnyJoMs/20251214/SeRS/4320X4288/balloon2.png/webp',
          'https://test.fukit.cn/autoupload/f/IeSYb0Mnf1Z62nIKYGB4NyfNcKcqEnRmcljopnyJoMs/20251214/mzlX/4284X4252/balloon3.png/webp'
        ],
        giftImage: './images/usagi-surprise.png',
        loginBackground: 'https://xland.eu.org/autoupload/f/IeSYb0Mnf1Z62nIKYGB4NyfNcKcqEnRmcljopnyJoMs/20251211/js6e/1922X1074/background.jpg', 
        backBtn: 'https://test.fukit.cn/autoupload/f/IeSYb0Mnf1Z62nIKYGB4NyfNcKcqEnRmcljopnyJoMs/20251214/bzad/2768X2688/back.png/webp',
        wizardHat: 'https://cdn-icons-png.flaticon.com/512/867/867909.png', // Fallback or explicit URL
        magicCircle: 'https://cdn-icons-png.flaticon.com/512/3222/3222642.png',
        sounds: {
          bgm: BGM_URL,
          pageFlip: 'https://assets.mixkit.co/active_storage/sfx/2405/2405-preview.mp3' // Added basic placeholder sound
        }
      };

      const BIRTHDAY_LETTER = `ÊÅ≠Âñú‰Ω†ÂèàËÄÅ‰∏ÄÂ≤ÅÔΩû‰ΩÜÊ≤°ÂÖ≥Á≥ªÔºå‰æùÊóßÂèØ‰ª•ÂÅöÈÇ£‰∏™ÊÜ®ÊÜ®ÁöÑ‰πåËê®Â•áÈ∫ªÈ∫ªÔºå‰æùÊóßÊòØËá™Â∏¶ÂÖâËäíÁöÑ ENFJ Â∞èÂ§™Èò≥ÔºåÂ∏åÊúõ‰Ω†‰∏ÄÁõ¥ÊúâÂêë‰∏äÁöÑÁîüÂëΩÂäõÔºåÊ∞∏ËøúÂÅöÊúÄËÄÄÁúº„ÄÅÊúÄÈ≤úÊ¥ªÁöÑËá™Â∑±ÔºÅ
Âó®ÁöÆÊ≥¢ÊñØ day to cute yeahÔΩû`;

      const PHOTOS = [
        // Landscape (4:3) - Layout: 2 per page
        { id: 1, url: 'https://test.fukit.cn/autoupload/f/IeSYb0Mnf1Z62nIKYGB4NyfNcKcqEnRmcljopnyJoMs/20251223/SIMw/1364X1024/P1.jpg/webp', desc: "‰πåËê®Â•áÁúãÈïúÂ§¥", type: 'landscape' },
        { id: 7, url: 'https://test.fukit.cn/autoupload/f/IeSYb0Mnf1Z62nIKYGB4NyfNcKcqEnRmcljopnyJoMs/20251225/3Rs1/1440X1080/a17f038635eba6b3a283f0f1ad4e4441.jpg/webp', desc: "‰∏§‰∏™biking", type: 'landscape' },
        { id: 8, url: 'https://test.fukit.cn/autoupload/f/IeSYb0Mnf1Z62nIKYGB4NyfNcKcqEnRmcljopnyJoMs/20251225/z3xC/1706X1279/386fdc42b3fcac20dba8304591709db8.jpg/webp', desc: "ÊàëË∂ÖÂá∂ÁöÑÔºÅ", type: 'landscape' },
        { id: 9, url: 'https://test.fukit.cn/autoupload/f/IeSYb0Mnf1Z62nIKYGB4NyfNcKcqEnRmcljopnyJoMs/20251225/VK3S/1366X1024/8fece183095b0e157ea8e6703318d944.jpg/webp', desc: "ÊÑüËßâËá™Â∑±ËêåËêåÂìíÔΩû", type: 'landscape' },
        
        // Portrait (3:4) - Layout: 1 per page
        { id: 2, url: 'https://test.fukit.cn/autoupload/f/IeSYb0Mnf1Z62nIKYGB4NyfNcKcqEnRmcljopnyJoMs/20251225/cPnS/3072X4096/e736a48181bb253bf685ec22b14c3caf.jpg/webp', desc: "ÊêûÊÄ™‰∏Ä‰∏ã", type: 'portrait' },
        { id: 3, url: 'https://test.fukit.cn/autoupload/f/IeSYb0Mnf1Z62nIKYGB4NyfNcKcqEnRmcljopnyJoMs/20251225/GC29/1200X1600/5a679fe11545262fa160f080823922b4.jpg/webp', desc: "ÂèØÁà±ÁöÑÁû¨Èó¥", type: 'portrait' },
        { id: 4, url: 'https://test.fukit.cn/autoupload/f/IeSYb0Mnf1Z62nIKYGB4NyfNcKcqEnRmcljopnyJoMs/20251225/CYct/1168X1456/5bdf474670122faa7d35762ce43bbbdc.jpg/webp', desc: "Âø´‰πêÊØè‰∏ÄÂ§©", type: 'portrait' },
        { id: 5, url: 'https://test.fukit.cn/autoupload/f/IeSYb0Mnf1Z62nIKYGB4NyfNcKcqEnRmcljopnyJoMs/20251226/FQa1/1366X1821/p3.png/webp', desc: "Ëá™Áî±ÁöÑÈ£é", type: 'portrait' },
        { id: 6, url: 'https://test.fukit.cn/autoupload/f/IeSYb0Mnf1Z62nIKYGB4NyfNcKcqEnRmcljopnyJoMs/20251225/b2d3/1279X1706/22c54f160ed4a8cc8fd04376a96874a2.jpg/webp', desc: "ÂÖâËäí‰∏á‰∏à", type: 'portrait' },
        { id: 10, url: 'https://test.fukit.cn/autoupload/f/IeSYb0Mnf1Z62nIKYGB4NyfNcKcqEnRmcljopnyJoMs/20251226/SYQY/1280X1707/3689579ea4db661ee9b39fce5e6dcd61.jpg/webp', desc: "ÁîüÊó•Âø´‰πê", type: 'portrait' }

      ];

      // --- 2. COMPONENTS ---

      // Dynamic Cake Component
      const DynamicCake = () => {
          const [bubbles, setBubbles] = useState([]);
          const [confettiPieces, setConfettiPieces] = useState([]);

          useEffect(() => {
              const interval = setInterval(() => {
                  const id = Date.now();
                  const xOffset = (Math.random() - 0.5) * 60; // Random x position
                  setBubbles(prev => [...prev, { id, x: xOffset }]);
                  
                  // Remove bubble after animation and trigger confetti
                  setTimeout(() => {
                      setBubbles(prev => prev.filter(b => b.id !== id));
                      // Trigger mini confetti burst
                      const newConfetti = Array.from({length: 5}).map((_, i) => ({
                          id: id + i,
                          x: xOffset,
                          color: ['#FFC107', '#FF4081', '#00E676', '#2979FF'][Math.floor(Math.random() * 4)],
                          angle: Math.random() * 360,
                          distance: Math.random() * 40 + 20
                      }));
                      setConfettiPieces(prev => [...prev, ...newConfetti]);
                      setTimeout(() => {
                          setConfettiPieces(prev => prev.filter(p => !newConfetti.find(nc => nc.id === p.id)));
                      }, 1000);
                  }, 1500); // Bubble duration
              }, 2000); // Bubble spawn rate

              return () => clearInterval(interval);
          }, []);

          return (
              <div className="relative flex items-center justify-center">
                  <div className="text-[6rem] drop-shadow-2xl filter hover:scale-110 transition-transform duration-300 cursor-pointer relative z-10">
                      üéÇ
                  </div>
                  {/* Bubbles */}
                  <AnimatePresence>
                      {bubbles.map(b => (
                          <motion.div
                              key={b.id}
                              initial={{ opacity: 0, y: 0, scale: 0.5 }}
                              animate={{ opacity: [0.8, 0], y: -60, scale: 1.2 }}
                              exit={{ opacity: 0 }}
                              transition={{ duration: 1.5, ease: "easeOut" }}
                              className="absolute top-4 w-4 h-4 bg-white/80 rounded-full blur-[1px]"
                              style={{ left: `calc(50% + ${b.x}px)` }}
                          />
                      ))}
                  </AnimatePresence>
                  {/* Confetti */}
                  <AnimatePresence>
                      {confettiPieces.map(c => (
                          <motion.div
                              key={c.id}
                              initial={{ opacity: 1, x: c.x, y: -60, scale: 1 }}
                              animate={{ 
                                  opacity: 0, 
                                  x: c.x + Math.cos(c.angle * Math.PI / 180) * c.distance, 
                                  y: -60 + Math.sin(c.angle * Math.PI / 180) * c.distance,
                                  rotate: c.angle * 2
                              }}
                              transition={{ duration: 0.8, ease: "easeOut" }}
                              className="absolute top-4 w-1.5 h-1.5 rounded-sm"
                              style={{ backgroundColor: c.color, left: '50%' }}
                          />
                      ))}
                  </AnimatePresence>
              </div>
          );
      };

      // Sticker Component for Decorations
      const StickerDecoration = ({ children, className, rotate }) => (
         <motion.div 
            className={`absolute z-20 pointer-events-none bg-white/90 p-1.5 shadow-sticker border-2 border-white rounded-lg ${className}`}
            style={{ rotate: rotate }}
            initial={{ scale: 0, opacity: 0 }}
            animate={{ scale: 1, opacity: 1 }}
            transition={{ type: "spring", delay: Math.random() + 0.5 }}
         >
            {children}
         </motion.div>
      );

      // Falling Petals / Sugar Component (Updated for Atmosphere)
      const FallingPetals = () => {
         const petals = useMemo(() => Array.from({ length: 40 }).map((_, i) => ({
             id: i,
             left: Math.random() * 100,
             // Light pinks, creams, and whites for sugar/petals
             color: ['#FFC1E3', '#FFF9C4', '#FFFFFF', '#FFECB3'][Math.floor(Math.random() * 4)],
             size: Math.random() * 6 + 4,
             delay: Math.random() * 5,
             duration: Math.random() * 10 + 10,
             shape: Math.random() > 0.6 ? '50%' : '2px' // Circle (sugar) or slight rounded square
         })), []);

         return (
             <div className="absolute inset-0 pointer-events-none overflow-hidden z-[5]">
                 {petals.map(s => (
                     <motion.div
                         key={s.id}
                         className="absolute opacity-80"
                         style={{ 
                             left: `${s.left}%`, 
                             top: -20, 
                             width: s.size, 
                             height: s.size, 
                             backgroundColor: s.color,
                             borderRadius: s.shape,
                             boxShadow: '0 2px 4px rgba(0,0,0,0.05)'
                         }}
                         animate={{ 
                             y: '110vh', 
                             rotate: [0, 180, 360],
                             x: [0, Math.random() * 40 - 20, 0]
                         }}
                         transition={{ 
                             duration: s.duration, 
                             repeat: Infinity, 
                             delay: s.delay, 
                             ease: "linear" 
                         }}
                     />
                 ))}
             </div>
         );
      };

      // Background Component
      const Background = () => {
        const [mousePosition, setMousePosition] = useState({ x: 0, y: 0 });
        
        // Mini Balloons Generator
        const miniBalloons = useMemo(() => Array.from({ length: 12 }).map((_, i) => ({
            id: i,
            left: Math.random() * 100,
            delay: Math.random() * 10,
            duration: Math.random() * 10 + 20,
            color: i % 2 === 0 ? '#F8C8DC' : '#B3E5FC', // Pink and Blue
            size: Math.random() * 20 + 15
        })), []);

        useEffect(() => {
          const handleMouseMove = (e) => setMousePosition({ x: e.clientX, y: e.clientY });
          window.addEventListener('mousemove', handleMouseMove);
          return () => window.removeEventListener('mousemove', handleMouseMove);
        }, []);

        return (
          <div className="fixed inset-0 z-0 overflow-hidden pointer-events-none">
            {/* Base: Pale Cream Yellow Gradient */}
            <div className="absolute inset-0 bg-gradient-to-b from-[#FFFDE7] to-[#FFE0B2]"></div>
            
            {/* Overlay: Cream Cake Texture (Clouds with lower opacity) */}
            <div className="absolute inset-0 bg-clouds opacity-20 mix-blend-overlay"></div>
            
            {/* Dynamic: Mini Floating Balloons */}
            {miniBalloons.map(b => (
                <motion.div 
                    key={b.id}
                    className="absolute rounded-full opacity-60 backdrop-blur-sm"
                    style={{
                        width: b.size,
                        height: b.size * 1.2,
                        backgroundColor: b.color,
                        left: `${b.left}%`,
                        top: '110%',
                        boxShadow: 'inset -2px -2px 5px rgba(0,0,0,0.1)'
                    }}
                    animate={{ y: '-120vh', rotate: [0, 5, -5, 0] }}
                    transition={{ 
                        y: { duration: b.duration, repeat: Infinity, delay: b.delay, ease: "linear" },
                        rotate: { duration: 3, repeat: Infinity, ease: "easeInOut" }
                    }}
                >
                    {/* String */}
                    <div className="absolute top-full left-1/2 w-[1px] h-8 bg-black/20 origin-top animate-sway"></div>
                </motion.div>
            ))}

            <motion.div initial={{ x: -100 }} animate={{ x: '100vw' }} transition={{ duration: 35, repeat: Infinity, ease: 'linear' }} className="absolute top-10 left-0 text-white opacity-40 text-9xl blur-sm">‚òÅÔ∏è</motion.div>
            
            {/* Floating Orbs */}
            {Array.from({ length: 20 }).map((_, i) => (
              <motion.div key={i} className="absolute rounded-full bg-[#FBBF77] shadow-[0_0_10px_#FBBF77]"
                style={{ width: Math.random() * 8 + 4, height: Math.random() * 8 + 4, top: `${Math.random() * 100}%`, left: `${Math.random() * 100}%`, x: (mousePosition.x * 0.02 * (i % 2 === 0 ? 1 : -1)), y: (mousePosition.y * 0.02 * (i % 2 === 0 ? 1 : -1)) }}
                animate={{ opacity: [0.4, 1, 0.4], scale: [1, 1.2, 1] }} transition={{ duration: 1, repeat: Infinity, delay: Math.random() * 2 }}
              />
            ))}
          </div>
        );
      };

      // Flickering Candle Lights Component
      const FlickeringCandles = () => {
          const candles = useMemo(() => Array.from({ length: 8 }).map((_, i) => ({
              id: i,
              left: Math.random() * 90 + 5,
              top: Math.random() * 80 + 10,
              delay: Math.random() * 2
          })), []);

          return (
              <div className="absolute inset-0 pointer-events-none overflow-hidden z-[6]">
                  {candles.map(c => (
                      <motion.div
                          key={c.id}
                          className="absolute w-2 h-2 rounded-full bg-yellow-200 blur-[2px]"
                          style={{ left: `${c.left}%`, top: `${c.top}%`, boxShadow: "0 0 10px 2px rgba(255, 200, 0, 0.4)" }}
                          animate={{ opacity: [0.2, 0.8, 0.2], scale: [1, 1.2, 1] }}
                          transition={{ duration: 2 + Math.random(), repeat: Infinity, delay: c.delay, ease: "easeInOut" }}
                      />
                  ))}
              </div>
          );
      };

      // Scene Decorations (Bottom Cream Piping)
      const SceneDecorations = () => {
        return (
          <>
             <div className="absolute bottom-0 w-full h-32 z-10 pointer-events-none opacity-90">
                {/* Layer 1: Light Yellow Cream */}
                <svg viewBox="0 0 1440 320" className="absolute bottom-0 w-full h-full text-[#FFF9C4]" preserveAspectRatio="none">
                   <path fill="currentColor" fillOpacity="1" d="M0,224L48,213.3C96,203,192,181,288,181.3C384,181,480,203,576,224C672,245,768,267,864,261.3C960,256,1056,224,1152,197.3C1248,171,1344,149,1392,138.7L1440,128L1440,320L1392,320C1344,320,1248,320,1152,320C1056,320,960,320,864,320C768,320,672,320,576,320C480,320,384,320,288,320C192,320,96,320,48,320L0,320Z"></path>
                </svg>
                {/* Layer 2: Light Lime Cream */}
                <svg viewBox="0 0 1440 320" className="absolute bottom-0 w-full h-full text-[#F0F4C3]" preserveAspectRatio="none" style={{ transform: 'scaleX(-1) translateY(20px)' }}>
                   <path fill="currentColor" fillOpacity="1" d="M0,192L48,208C96,224,192,256,288,245.3C384,235,480,181,576,170.7C672,160,768,192,864,208C960,224,1056,224,1152,202.7C1248,181,1344,139,1392,117.3L1440,96L1440,320L1392,320C1344,320,1248,320,1152,320C1056,320,960,320,864,320C768,320,672,320,576,320C480,320,384,320,288,320C192,320,96,320,48,320L0,320Z"></path>
                </svg>
             </div>
          </>
        );
      };

      // Mini Countdown Component (Refined: Cloud Bubble + Flame)
      const MiniCountdown = () => {
         return (
            <div className="absolute top-6 right-[calc(1.5rem+2cm)] z-50 pointer-events-none">
               <motion.div 
                  initial={{ y: -50, opacity: 0 }}
                  animate={{ y: 0, opacity: 1 }}
                  transition={{ delay: 1, type: "spring" }}
                  className="bg-[#FFF9E6] px-2 py-1 rounded-[30px] border-4 border-[#F8C8DC] shadow-[0_6px_0_#F48FB1] transform rotate-3 flex items-center gap-3"
               >
                  <span className="font-cute text-xl text-[#5D4037] font-bold flex items-center gap-1">
                     <span>Ë∑ùÁ¶ªÁîüÊó•ËøòÊúâ <span className="text-2xl text-[#FF8A80] mx-1">0</span> Â§©</span>
                  </span>
                  <div className="relative">
                      <motion.span 
                          className="text-3xl block"
                          animate={{ scale: [1, 1.1, 1] }}
                          transition={{ duration: 1.5, repeat: Infinity, ease: "easeInOut" }}
                      >
                          üéÇ
                      </motion.span>
                      {/* Flame effect overlay */}
                      <motion.div 
                          className="absolute -top-1 left-1/2 -translate-x-1/2 w-2 h-3 bg-gradient-to-t from-orange-400 to-yellow-200 rounded-full blur-[2px]"
                          animate={{ scale: [1, 1.3, 0.9, 1.2], opacity: [0.8, 1, 0.7] }}
                          transition={{ duration: 0.5, repeat: Infinity }}
                      />
                  </div>
               </motion.div>
            </div>
         );
      };

      // Back Button
      const BackButton = ({ onClick, disabled = false, scene }) => {
        const [isAnimating, setIsAnimating] = useState(false);
        const isVinyl = scene === 'VINYL';

        const handleClick = (e) => {
          if (e && e.stopPropagation) e.stopPropagation();
          if (disabled || isAnimating) return;
          setIsAnimating(true);
          setTimeout(() => {
             onClick();
             setTimeout(() => setIsAnimating(false), 200);
          }, 600);
        };

        return (
          <motion.div 
            className="fixed top-0 left-6 z-[60] flex flex-col items-center"
            initial={{ y: -200, opacity: 0 }} 
            animate={{ 
               y: disabled ? -200 : 0, 
               opacity: disabled ? 0 : 1,
               pointerEvents: disabled ? 'none' : 'auto'
            }} 
            transition={{ duration: 0.8, type: "spring", stiffness: 60 }}
          >
            <div className="w-[1.5px] h-10 bg-[#8D6E63]/60 shadow-sm relative z-0 origin-top"></div>
            <motion.div
               className="cursor-pointer relative z-10 -mt-1 origin-top"
               onClick={handleClick}
               whileHover={{ 
                  rotate: [0, -5, 5, 0], 
                  transition: { repeat: Infinity, duration: 3, ease: "easeInOut" } 
               }}
               animate={
                 isVinyl 
                 ? { rotate: [-10, 10, -10], y: [0, 2, 0] } 
                 : (isAnimating ? { y: [0, 60, 0] } : { y: 0 })
               }
               transition={
                 isVinyl 
                 ? { rotate: { repeat: Infinity, duration: 2, ease: "easeInOut" }, y: { repeat: Infinity, duration: 1 } }
                 : (isAnimating ? { duration: 0.6, times: [0, 0.4, 1], ease: "easeInOut" } : {})
               }
            >
               <img 
                 src={ASSETS.backBtn}
                 alt="Back" 
                 className="w-20 md:w-24 object-contain filter drop-shadow-lg hover:brightness-105 transition-all" 
                 draggable="false"
               />
            </motion.div>
          </motion.div>
        );
      };

      // SCENE 0: LOGIN
      const Scene0Login = ({ onLogin, playBGM }) => {
        const [showPassword, setShowPassword] = useState(false);
        const [username, setUsername] = useState('');
        const [password, setPassword] = useState('');
        const [error, setError] = useState('');
        const [shake, setShake] = useState(false);

        const handleLogin = (e) => {
          e.preventDefault();
          if (username === 'xiaoma' && password === '1227') {
            setError('');
            // Play audio *immediately* on user interaction
            if (playBGM) playBGM();
            onLogin();
          } else {
            setError('Ë¥¶Âè∑ÊàñÂØÜÁ†ÅÈîôËØØÔºåËØ∑ÈáçËØï');
            setShake(true);
            setTimeout(() => setShake(false), 500);
          }
        };

        return (
          <motion.div 
            className="fixed inset-0 z-50 flex items-center justify-center bg-cover bg-center overflow-hidden"
            style={{ backgroundImage: `url(${ASSETS.loginBackground})` }}
            initial={{ opacity: 0 }}
            animate={{ opacity: 1 }}
            exit={{ opacity: 0, scale: 1.1 }}
            transition={{ duration: 0.8 }}
          >
            <div className="absolute inset-0 bg-black/20 backdrop-blur-[1px]"></div>

            <motion.div 
              className="glass-card w-[90%] max-w-[400px] rounded-2xl p-8 relative z-10 flex flex-col items-center"
              initial={{ y: 50, opacity: 0 }}
              animate={shake ? { x: [-10, 10, -10, 10, 0] } : { y: 0, opacity: 1 }}
              transition={shake ? { duration: 0.4 } : { delay: 0.2, type: "spring", stiffness: 50 }}
            >
              <h2 className="text-3xl font-bold text-white mb-2 tracking-wide drop-shadow-md">Ê¨¢ËøéÂõûÊù•</h2>
              <p className="text-white/80 text-sm mb-6">ËØ∑ÁôªÂΩïÊÇ®ÁöÑË¥¶Êà∑</p>

              <form onSubmit={handleLogin} className="w-full space-y-4">
                <div className="relative group">
                  <div className="absolute left-4 top-1/2 -translate-y-1/2 text-gray-500 transition-colors group-focus-within:text-usagi-orange">
                    <User size={20} />
                  </div>
                  <input 
                    type="text" 
                    value={username}
                    onChange={(e) => setUsername(e.target.value)}
                    placeholder="Â∞è‰∏ªÔºåËØ∑Ëµê‰∏™Áî®Êà∑Âêç" 
                    className="w-full py-3.5 pl-12 pr-4 rounded-2xl bg-white/80 border-none outline-none focus:bg-white focus:ring-2 focus:ring-usagi-orange/50 transition-all placeholder:text-gray-500 text-gray-700"
                  />
                </div>

                <div className="relative group">
                  <div className="absolute left-4 top-1/2 -translate-y-1/2 text-gray-500 transition-colors group-focus-within:text-usagi-orange">
                    <Lock size={20} />
                  </div>
                  <input 
                    type={showPassword ? "text" : "password"} 
                    value={password}
                    onChange={(e) => setPassword(e.target.value)}
                    placeholder="ËØ∑Âá∫Á§∫ÂèñÈ§êÁ†Å" 
                    className="w-full py-3.5 pl-12 pr-12 rounded-2xl bg-white/80 border-none outline-none focus:bg-white focus:ring-2 focus:ring-usagi-orange/50 transition-all placeholder:text-gray-500 text-gray-700"
                  />
                  <button 
                    type="button"
                    onClick={() => setShowPassword(!showPassword)}
                    className="absolute right-4 top-1/2 -translate-y-1/2 text-gray-400 hover:text-gray-600 focus:outline-none"
                  >
                    {showPassword ? <EyeOff size={20} /> : <Eye size={20} />}
                  </button>
                </div>

                {error && (
                  <motion.div initial={{ opacity: 0, height: 0 }} animate={{ opacity: 1, height: 'auto' }} className="text-red-200 bg-red-500/30 px-3 py-1 rounded-2xl text-xs text-center font-bold">
                    {error}
                  </motion.div>
                )}

                <div className="flex justify-between items-center text-xs text-white/90 px-1">
                  <label className="flex items-center gap-2 cursor-pointer hover:text-white transition-colors">
                    <input type="checkbox" className="w-4 h-4 rounded border-gray-300 text-usagi-orange focus:ring-usagi-orange" />
                    <span>ËÆ∞‰ΩèÊàë</span>
                  </label>
                  <button type="button" className="hover:underline hover:text-white transition-colors">ÂøòËÆ∞ÂØÜÁ†Å?</button>
                </div>

                <button 
                  type="submit"
                  className="w-full py-3.5 rounded-2xl bg-gradient-to-r from-[#8A7CFB] to-[#635BFF] text-white font-bold text-lg shadow-lg hover:shadow-xl hover:opacity-90 active:scale-[0.98] transition-all mt-4"
                >
                  Â∞è‰∏ªËØ∑Ëøõ
                </button>
              </form>

              <div className="w-full flex items-center gap-4 my-6 text-white/60 text-xs">
                <div className="h-px bg-white/30 flex-1"></div>
                <span>ÊàñËÄÖ</span>
                <div className="h-px bg-white/30 flex-1"></div>
              </div>

              <div className="w-full space-y-3">
                <button className="w-full py-2.5 rounded-2xl bg-white/90 hover:bg-white text-[#07C160] font-bold border border-[#07C160]/20 flex items-center justify-center gap-2 transition-all shadow-sm">
                  <MessageCircle size={20} fill="currentColor" className="text-[#07C160]" />
                  <span>‰ΩøÁî®ÂæÆ‰ø°ÁôªÂΩï</span>
                </button>
                <button className="w-full py-2.5 rounded-2xl bg-white/90 hover:bg-white text-[#0099FF] font-bold border border-[#0099FF]/20 flex items-center justify-center gap-2 transition-all shadow-sm">
                  <Bell size={20} fill="currentColor" className="text-[#0099FF]" />
                  <span>‰ΩøÁî®QQÁôªÂΩï</span>
                </button>
              </div>

              <div className="mt-8 text-xs text-white/80">
                ËøòÊ≤°ÊúâË¥¶Êà∑? <button className="text-blue-200 font-bold hover:underline ml-1">Á´ãÂç≥Ê≥®ÂÜå</button>
              </div>

            </motion.div>
          </motion.div>
        );
      };

      // Usagi Character Component
      const UsagiCharacter = ({ action, className, onClick, boardText, imageSrc, isHeart, boardVariant }) => {
        const variants = {
          idle: { y: [0, -5, 0], transition: { repeat: Infinity, duration: 2 } },
          jump: { y: [0, -50, 0], scale: [1, 1.1, 0.9, 1], transition: { repeat: Infinity, duration: 0.6 } },
          wave: { rotate: [0, 10, -10, 0], transition: { repeat: Infinity, duration: 1 } },
          camera: { scale: [1, 1.05, 1], transition: { duration: 0.3 } },
          cheer: { y: [0, -20, 0], transition: { repeat: Infinity, duration: 0.4 } },
          shhh: { scale: 1 },
          'hold-board': { y: [0, -3, 0], transition: { repeat: Infinity, duration: 3 } },
          heart: { scale: [1, 1.1, 1], transition: { duration: 0.5, repeat: Infinity, repeatDelay: 1 } }
        };

        return (
          <motion.div 
            className={`relative cursor-pointer select-none ${className}`}
            onClick={onClick}
            animate={action}
            variants={variants}
            whileHover={{ scale: 1.05 }}
            whileTap={{ scale: 0.95 }}
          >
            <img 
              src={imageSrc || "https://test.fukit.cn/autoupload/f/IeSYb0Mnf1Z62nIKYGB4NyfNcKcqEnRmcljopnyJoMs/20251214/P3yB/4272X4300/mai.png/webp"} 
              alt="Character" 
              className="w-full h-full object-contain drop-shadow-lg pointer-events-none"
              draggable="false"
            />
            
            {action === 'heart' && (
                <motion.div 
                  className="absolute -top-4 -right-4 text-4xl filter drop-shadow-md"
                  initial={{ scale: 0, opacity: 0 }}
                  animate={{ scale: [1, 1.2, 1], opacity: 1 }}
                  transition={{ duration: 0.8, repeat: Infinity }}
                >
                  ‚ù§Ô∏è
                </motion.div>
            )}

            {action === 'camera' && (
                <motion.div 
                  className="absolute bottom-0 right-0 text-3xl filter drop-shadow-md"
                  initial={{ opacity: 0 }}
                  animate={{ opacity: 1 }}
                >
                  üì∑
                </motion.div>
            )}
            
            {action === 'hold-board' && (
               <motion.div 
                   initial={{ opacity: 0 }}
                   animate={{ opacity: 1 }}
                   transition={{ delay: 2.0, duration: 0.5 }}
                   className={`absolute left-1/2 -translate-x-1/2 -translate-y-1/2 flex items-center justify-center
                  ${isHeart 
                     ? 'top-[58%] h-[24%] rotate-0' 
                     : 'top-[55%] w-[110%] h-[40%] max-w-[300px]'}`}
                   style={isHeart ? { marginTop: '-4.5cm', marginLeft: '10.5cm', width: 'calc(38% + 0.5cm)', transform: 'scale(1.5)', transformOrigin: 'center' } : {}}
               >
                  {boardVariant === 'pumpkin' ? (
                     <div className="w-full h-full pumpkin-bubble flex items-center justify-center p-4 text-center z-10">
                        <div className="font-creamy text-[#5D4037] text-lg md:text-xl leading-tight break-words w-full h-full flex items-center justify-center gap-1">
                           {boardText} <span className="text-xl relative left-[15cm]">üçÅ</span>
                        </div>
                     </div>
                  ) : (
                    <div className={`w-full h-full flex items-center justify-center p-3 text-center bg-white border-4 border-dashed border-usagi-orange rounded-xl shadow-lg relative z-10
                        ${isHeart ? 'transform rotate-0' : 'transform -rotate-2'}`}
                    >
                        <div className={`font-hand text-usagi-text leading-tight break-words w-full h-full flex items-center justify-center
                            ${isHeart ? 'text-xs md:text-lg font-bold' : 'text-sm md:text-xl'}`}
                        >
                            {boardText}
                        </div>
                    </div>
                  )}
               </motion.div>
            )}
          </motion.div>
        );
      };

      // Atmosphere Particles
      const AtmosphereParticles = () => {
        const particles = useMemo(() => Array.from({ length: 15 }).map((_, i) => ({
          id: i,
          x: Math.random() * 100,
          y: Math.random() * 100,
          size: Math.random() * 10 + 5,
          color: ['#FFCdd2', '#FFF9C4', '#B2DFDB'][Math.floor(Math.random() * 3)],
          duration: Math.random() * 10 + 10,
          delay: Math.random() * 5
        })), []);

        return (
          <div className="absolute inset-0 pointer-events-none overflow-hidden z-0">
            {particles.map((p) => (
              <motion.div
                key={p.id}
                className="absolute rounded-full opacity-30"
                style={{
                  left: `${p.x}%`,
                  top: -20,
                  width: p.size,
                  height: p.size,
                  backgroundColor: p.color,
                  boxShadow: `0 0 10px ${p.color}`
                }}
                animate={{
                  y: ['0vh', '100vh'],
                  x: [0, Math.random() * 50 - 25],
                  rotate: [0, 360]
                }}
                transition={{
                  duration: p.duration,
                  repeat: Infinity,
                  ease: "linear",
                  delay: p.delay
                }}
              />
            ))}
          </div>
        );
      };

      // Autumn Atmosphere: Falling Maple Leaves & Pumpkin Seeds
      const AutumnAtmosphere = React.memo(() => {
        const items = useMemo(() => Array.from({ length: 25 }).map((_, i) => ({
          id: i,
          type: Math.random() > 0.5 ? 'maple' : 'seed',
          x: Math.random() * 100,
          delay: Math.random() * 5,
          duration: Math.random() * 10 + 10,
          size: Math.random() * 15 + 10
        })), []);

        return (
          <div className="absolute inset-0 pointer-events-none overflow-hidden z-0">
            {items.map(item => (
              <motion.div
                key={item.id}
                className="absolute opacity-80"
                style={{
                  left: `${item.x}%`,
                  top: -50,
                  fontSize: `${item.size}px`
                }}
                initial={{ y: -50, rotate: 0 }}
                animate={{ 
                  y: '110vh', 
                  rotate: item.type === 'maple' ? [0, 45, -45, 180] : [0, 360],
                  x: [0, Math.random() * 100 - 50, 0]
                }}
                transition={{
                  duration: item.duration,
                  repeat: Infinity,
                  delay: item.delay,
                  ease: "linear"
                }}
              >
                {item.type === 'maple' ? 'üçÅ' : 'üéÉ'} 
                {/* Note: Using pumpkin emoji as seed/pumpkin bit representation for visual clarity */}
              </motion.div>
            ))}
          </div>
        );
      });

      // Pumpkin Seeds Rolling Component
      const PumpkinSeeds = () => {
        return (
          <div 
            className="absolute bottom-[20%] right-[30%] md:right-[35%] z-20 flex gap-4 pointer-events-none"
            style={{ transform: 'translate(-9cm, 1cm)' }}
          >
             <motion.div 
               className="text-[120px]"
               animate={{ rotate: [0, 10, -10, 0], x: [0, 2, -2, 0] }}
               transition={{ duration: 3, repeat: Infinity, ease: "easeInOut" }}
             >
               üéÉ
             </motion.div>
          </div>
        );
      };

      // Particle Button Component
      const ParticleButton = ({ onClick, children, className }) => {
        const [isHovered, setIsHovered] = useState(false);
        
        return (
          <motion.button 
            onClick={onClick}
            onMouseEnter={() => setIsHovered(true)}
            onMouseLeave={() => setIsHovered(false)}
            whileHover={{ scale: 1.1 }}
            whileTap={{ scale: 0.95 }}
            className={`relative overflow-visible group ${className}`}
          >
            {children}
            <AnimatePresence>
              {isHovered && (
                <>
                  {Array.from({ length: 6 }).map((_, i) => (
                    <motion.div
                      key={i}
                      initial={{ opacity: 0, scale: 0, x: 0, y: 0 }}
                      animate={{ 
                        opacity: [0, 1, 0], 
                        scale: [0.5, 1, 0.5], 
                        x: (Math.random() - 0.5) * 60, 
                        y: -30 - Math.random() * 40 
                      }}
                      exit={{ opacity: 0 }}
                      transition={{ duration: 0.8, repeat: Infinity, delay: i * 0.1 }}
                      className="absolute top-0 left-1/2 -translate-x-1/2 text-pink-500 text-sm pointer-events-none"
                    >
                      ‚ù§Ô∏è
                    </motion.div>
                  ))}
                </>
              )}
            </AnimatePresence>
          </motion.button>
        );
      };

      // SCENE 1: Intro (Modified)
      const Scene1Intro = ({ onStart }) => {
        const BALLOON_TEXTS = ["ËøôÊòØ‰∏Ä‰∏™ÊúâÁùÄÈ¶ôÊ∞îÁöÑÊôö‰∏ä~", "Âø´‰πêÁõ¥Êé•ÊãâÊª°Ê†º‚ú®", "Èí±ÂåÖÂíåÁîüÊ¥ªÔºåÂÖ®Ë∑üÁùÄ‰Ω†Âêë‰∏äÁîüÈïøüå±", "Âπ≤È•≠Ëá™Áî±ÔºåÊ∞∏ËøúËãóÊù°",  "‰Ω†ÁöÑ rap ËØçÂ∫ìÊ∞∏‰∏çÊûØÁ´≠Ôºåflow Ê∞∏ËøúÁÇ∏Âú∫üé§", "Â•ΩËøêËøΩÁùÄ‰Ω†ÁöÑÂÖÉÊ∞îË∑ë‰∏çÂÅúÔΩû"];
        
        const BALLOON_COLORS = [
           { shadow: 'rgba(255, 182, 193, 0.4)', filter: 'drop-shadow(0 15px 10px rgba(255, 105, 180, 0.2))' }, 
           { shadow: 'rgba(173, 216, 230, 0.4)', filter: 'drop-shadow(0 15px 10px rgba(70, 130, 180, 0.2))' }, 
           { shadow: 'rgba(255, 222, 173, 0.4)', filter: 'drop-shadow(0 15px 10px rgba(255, 165, 0, 0.2))' }
        ];

        const balloons = useMemo(() => {
          return Array.from({ length: 15 }).map((_, i) => {
            const scale = Math.random() * 0.4 + 0.8;
            const speed = Math.random() * 10 + 15;
            const sway = Math.random() * 50 + 30; // Amplitude
            const swayTime = Math.random() * 4 + 4; // Duration of one sway cycle
            
            return {
              id: i,
              src: ASSETS.balloons[i % ASSETS.balloons.length],
              colorConfig: BALLOON_COLORS[i % BALLOON_COLORS.length],
              left: Math.random() * 90 + 5,
              scale: scale,
              duration: speed,
              delay: Math.random() * 12,
              swayAmount: sway,
              swayDuration: swayTime,
              rotateAmount: Math.random() * 10 + 5
            };
          });
        }, []);

        const InteractiveBalloon = ({ config }) => {
          const [isClicked, setIsClicked] = useState(false);
          const [message, setMessage] = useState(null);

          const handleClick = (e) => {
            e.stopPropagation();
            setIsClicked(true);
            setMessage(BALLOON_TEXTS[Math.floor(Math.random() * BALLOON_TEXTS.length)]);
            
            setTimeout(() => setIsClicked(false), 300);
            setTimeout(() => setMessage(null), 1500);
          };

          return (
            <motion.div
              className="absolute"
              style={{ left: `${config.left}%`, bottom: '-150px', zIndex: 15 }}
              animate={{ 
                y: -window.innerHeight - 300,
                x: [0, config.swayAmount, -config.swayAmount/2, config.swayAmount/2, 0] // Natural wandering path
              }}
              transition={{ 
                y: { duration: config.duration, ease: "linear", repeat: Infinity, delay: config.delay }, 
                x: { duration: config.swayDuration, ease: "easeInOut", repeat: Infinity, repeatType: "mirror" }
              }}
            >
              <motion.div
                onClick={handleClick}
                style={{ filter: config.colorConfig.filter }}
                animate={isClicked ? { scale: 1.2, rotate: [0, -10, 10, 0] } : { 
                  scale: config.scale, 
                  rotate: [0, config.rotateAmount, 0, -config.rotateAmount, 0],
                  y: [0, -15, 0], // Internal bobbing for extra floatiness
                  x: [0, Math.random() * 10 - 5, 0] // Subtle turbulence
                }}
                transition={isClicked ? { duration: 0.3 } : { 
                  rotate: { duration: config.swayDuration - 1, ease: "easeInOut", repeat: Infinity },
                  y: { duration: 3, ease: "easeInOut", repeat: Infinity },
                  x: { duration: 5, ease: "easeInOut", repeat: Infinity, delay: Math.random() * 5 }
                }}
                className="relative cursor-pointer select-none"
                whileHover={{ scale: 1.1 }}
              >
                <img src={config.src} className="w-[100px] object-contain opacity-90" alt="balloon" draggable="false"/>
                
                <div 
                   className="absolute bottom-2 left-1/2 -translate-x-1/2 w-3/4 h-4 rounded-full blur-md opacity-40 pointer-events-none"
                   style={{ background: config.colorConfig.shadow }}
                ></div>

                <AnimatePresence>
                  {message && (
                    <motion.div
                      initial={{ opacity: 0, scale: 0, y: 10 }}
                      animate={{ opacity: 1, scale: 1, y: -50 }}
                      exit={{ opacity: 0, scale: 0.5, y: -70 }}
                      transition={{ duration: 0.3 }}
                      className="absolute left-1/2 -translate-x-1/2 top-0 bg-white/95 px-3 py-1.5 rounded-xl text-usagi-text text-sm font-bold shadow-lg border-2 border-usagi-pink/50 whitespace-nowrap z-50 pointer-events-none"
                    >
                      {message}
                      <div className="absolute -bottom-1.5 left-1/2 -translate-x-1/2 w-3 h-3 bg-white/95 rotate-45 border-b-2 border-r-2 border-usagi-pink/50"></div>
                    </motion.div>
                  )}
                </AnimatePresence>
              </motion.div>
            </motion.div>
          );
        };

        return (
          <motion.div className="relative w-full h-screen flex flex-col items-center justify-center z-10 overflow-hidden" exit={{ opacity: 0, x: -50 }}>
            <FallingPetals />
            <FlickeringCandles />
            <SceneDecorations />
            <MiniCountdown />

            {balloons.map((b) => (
              <InteractiveBalloon key={b.id} config={b} />
            ))}
            
            {/* Main Character with Glow Halo */}
            <motion.div 
               initial={{ x: -window.innerWidth, y: 100 }} 
               animate={{ x: 0, y: 0 }} 
               transition={{ type: "spring", stiffness: 60, damping: 15 }} 
               className="mb-8 relative z-20 cursor-pointer group" 
               whileHover={{ scale: 1.05 }} 
               onClick={onStart}
            >
              {/* Dynamic Halo: Pulsating Warm Yellow Light */}
              <motion.div 
                className="absolute inset-0 bg-[#F8C860]/40 rounded-full blur-3xl -z-10"
                animate={{ opacity: [0.4, 0.7, 0.4], scale: [0.9, 1.1, 0.9] }}
                transition={{ duration: 4, repeat: Infinity, ease: "easeInOut" }}
              />
              <UsagiCharacter action="jump" className="w-56 h-56 md:w-72 md:h-72 relative z-10" />
            </motion.div>
            
          {/* --- RE-DESIGNED WELCOME BUTTON: 3D Cream Cake Style --- */}
            <motion.div 
               className="relative group z-30"
               initial={{ opacity: 0, y: 20 }} 
               animate={{ opacity: 1, y: 0 }} 
               transition={{ delay: 0.8 }} 
            >
               {/* Rabbit Ears */}
               <div className="absolute -top-6 left-6 w-5 h-12 bg-[#FFFBE6] border-4 border-[#F48FB1] rounded-full transform -rotate-12 origin-bottom group-hover:-translate-y-1 transition-transform duration-300">
                  <div className="absolute top-2 left-1/2 -translate-x-1/2 w-2 h-6 bg-[#F48FB1]/30 rounded-full"></div>
               </div>
               <div className="absolute -top-6 right-6 w-5 h-12 bg-[#FFFBE6] border-4 border-[#F48FB1] rounded-full transform rotate-12 origin-bottom group-hover:-translate-y-1 transition-transform duration-300">
                  <div className="absolute top-2 left-1/2 -translate-x-1/2 w-2 h-6 bg-[#F48FB1]/30 rounded-full"></div>
               </div>

               {/* Button Body: Cream Cake Base + Pink Border + 3D Shadow */}
               <motion.button 
                  onClick={onStart}
                  whileHover={{ scale: 1.05 }}
                  whileTap={{ scale: 0.95 }} 
                  className="relative z-10 bg-[#FFF9C4] hover:bg-[#F8C8DC] text-[#5D4037] text-2xl font-cute font-bold py-3 px-12 rounded-2xl border-b-4 border-r-4 border-[#F06292] shadow-cake active:border-0 active:translate-y-[4px] active:shadow-none transition-all duration-200"
               >
                  Welcome
               </motion.button>
               
               {/* Hover Heart Particles */}
               <div className="absolute inset-0 pointer-events-none overflow-visible">
                  <motion.div className="absolute -top-4 left-0 text-2xl opacity-0 group-hover:opacity-100 drop-shadow-[0_0_5px_rgba(255,255,255,0.8)]" animate={{ y: [0, -20], opacity: [0, 1, 0] }} transition={{ duration: 1, repeat: Infinity }}>‚ù§Ô∏è</motion.div>
                  <motion.div className="absolute -top-8 right-2 text-xl opacity-0 group-hover:opacity-100 drop-shadow-[0_0_5px_rgba(255,255,255,0.8)]" animate={{ y: [0, -25], opacity: [0, 1, 0] }} transition={{ duration: 1.2, delay: 0.3, repeat: Infinity }}>üíï</motion.div>
                  <motion.div className="absolute -top-2 left-1/2 text-lg opacity-0 group-hover:opacity-100 drop-shadow-[0_0_5px_rgba(255,255,255,0.8)]" animate={{ y: [0, -15], opacity: [0, 1, 0] }} transition={{ duration: 0.8, delay: 0.6, repeat: Infinity }}>üíñ</motion.div>
               </div>

               {/* Tooltip Bubble */}
               <div className="absolute top-full mt-5 left-1/2 -translate-x-1/2 opacity-0 group-hover:opacity-100 transition-opacity duration-300 bg-white px-4 py-2 rounded-2xl border-2 border-[#F8C8DC] shadow-lg text-[#F06292] font-cute text-sm whitespace-nowrap pointer-events-none">
                  Êà≥ÊàëËß£ÈîÅÁîüÊó•ÊÉäÂñú~
                  <div className="absolute -top-2 left-1/2 -translate-x-1/2 w-3 h-3 bg-white border-t-2 border-l-2 border-[#F8C8DC] transform rotate-45"></div>
               </div>
            </motion.div>

          </motion.div>
        );
      };

      // --- SCENE 2: 3D FlipBook Photo Wall (FIXED) ---
      const Scene2PhotoWall = ({ isActive, onNext, isBackgroundMode }) => {
        const bookRef = useRef(null);
        const pageFlipRef = useRef(null);
        const [currentPage, setCurrentPage] = useState(0);
        const [totalPages, setTotalPages] = useState(0);
        const [showThumbnails, setShowThumbnails] = useState(false);
        const [activeCaptionId, setActiveCaptionId] = useState(null);
        const [isLoaded, setIsLoaded] = useState(false);

        // Group photos by layout logic
        // Rule 1: 4:3 (Landscape) -> 2 per page
        // Rule 2: 3:4 (Portrait) -> 1 per page
        const pagesData = useMemo(() => {
            const pages = [];
            const landscapePhotos = PHOTOS.filter(p => p.type === 'landscape');
            const portraitPhotos = PHOTOS.filter(p => p.type === 'portrait');

            // Pair landscapes
            for (let i = 0; i < landscapePhotos.length; i += 2) {
                const pair = [landscapePhotos[i]];
                if (i + 1 < landscapePhotos.length) pair.push(landscapePhotos[i+1]);
                pages.push({ type: 'landscape_pair', photos: pair });
            }

            // Single portraits
            portraitPhotos.forEach(p => {
                pages.push({ type: 'portrait_single', photos: [p] });
            });

            return pages;
        }, []);
        
        useEffect(() => {
          let pageFlipInstance = null;
          let retryCount = 0;
          
          const initBook = () => {
             // 1. Ensure DOM ref exists
             if (!bookRef.current) return;
             
             // 2. Ensure Library is loaded
             if (typeof window.St === 'undefined' || !window.St.PageFlip) {
                if (retryCount < 20) {
                    retryCount++;
                    setTimeout(initBook, 200);
                }
                return;
             }

             // 3. Prevent double initialization
             if (pageFlipRef.current) return;

             try {
                // 4. Create Instance
                pageFlipInstance = new window.St.PageFlip(bookRef.current, {
                    width: 600, // 400 * 1.5
                    height: 825, // 550 * 1.5
                    size: "stretch",
                    minWidth: 450,
                    maxWidth: 900,
                    minHeight: 600,
                    maxHeight: 1200,
                    showCover: true,
                    mobileScrollSupport: false, 
                    maxShadowOpacity: 0.5,
                    useMouseEvents: true
                });

                // 5. Load Pages (Must be in DOM)
                const pages = bookRef.current.querySelectorAll('.page');
                if (pages.length > 0) {
                    pageFlipInstance.loadFromHTML(pages);
                    
                    setTotalPages(pageFlipInstance.getPageCount());
                    
                    pageFlipInstance.on('flip', (e) => {
                        setCurrentPage(e.data);
                    });

                    pageFlipRef.current = pageFlipInstance;
                    setIsLoaded(true);
                } else {
                    // Retry if React hasn't rendered children yet
                    setTimeout(initBook, 100);
                }

             } catch (err) {
                 console.error("PageFlip init failed:", err);
                 // Fallback or retry?
             }
          };
          
          // Small delay to ensure React render cycle is complete
          const timer = setTimeout(initBook, 300);

          return () => {
             clearTimeout(timer);
             if (pageFlipRef.current) {
                pageFlipRef.current.destroy();
                pageFlipRef.current = null;
             }
          };
        }, []); // Mount once

        const goToPage = (idx) => {
            if(pageFlipRef.current) pageFlipRef.current.flip(idx);
        };
        
        const goNext = () => {
           if(pageFlipRef.current) pageFlipRef.current.flipNext();
        };

        const goPrev = () => {
           if(pageFlipRef.current) pageFlipRef.current.flipPrev();
        };

        const containerClass = isBackgroundMode ? 'blur-sm opacity-30 pointer-events-none scale-90 grayscale' : 'opacity-100 scale-100';

        // Check if book is at the end (approximation since pages might be displayed in spread)
        const isAtEnd = totalPages > 0 && currentPage >= totalPages - 2;

        return (
          <div className={`w-full h-full flex flex-col items-center justify-center transition-all duration-1000 ${containerClass} relative overflow-hidden`}>
            
            {/* Book Decoration on the Left - MAGNIFIED (2.5x) and Shifted */}
            <motion.img 
               src="https://test.fukit.cn/autoupload/f/IeSYb0Mnf1Z62nIKYGB4NyfNcKcqEnRmcljopnyJoMs/20251226/WKUj/3400X2840/book.png/webp"
               className="absolute bottom-4 left-4 md:bottom-8 md:left-8 w-80 md:w-[560px] z-20 pointer-events-none drop-shadow-xl" 
               initial={{ opacity: 0, x: -50 }}
               animate={{ opacity: 1, x: 0 }}
               transition={{ duration: 1, delay: 0.3 }}
            />

            {/* Left Camera Decoration (Flipped) - Shifted 30cm right - SWAPS IMAGE AT END */}
            <motion.img 
               key={isAtEnd ? "camera-end" : "camera-start"}
               src={isAtEnd 
                  ? "https://test.fukit.cn/autoupload/f/IeSYb0Mnf1Z62nIKYGB4NyfNcKcqEnRmcljopnyJoMs/20251214/4l2h/4320X4664/camera.png/webp"
                  : "https://test.fukit.cn/autoupload/f/IeSYb0Mnf1Z62nIKYGB4NyfNcKcqEnRmcljopnyJoMs/20251214/aFhf/4568X4876/camera1.png/webp"}
               className="absolute bottom-4 left-4 md:bottom-10 md:left-20 w-32 md:w-56 z-20 pointer-events-none transform -scale-x-100 drop-shadow-lg" 
               style={{ marginLeft: '29cm' }}
               initial={{ opacity: 0, x: -50 }}
               animate={{ opacity: 1, x: 0 }}
               transition={{ duration: 1, delay: 0.5 }}
            />

            {/* Book Container - Always render but hide until loaded to prevent FOUC */}
            <div className={`relative z-10 transition-opacity duration-700`} style={{ opacity: isLoaded ? 1 : 0, transform: 'translateX(5cm)' }}>
                <div id="book" ref={bookRef} className="flip-book shadow-2xl">
                    {/* Page 0: Front Cover - UPGRADED MAGIC VINTAGE STYLE */}
                    <div className="page hardcover" data-density="hard">
                        <div className="page-content w-full h-full relative overflow-hidden flex flex-col items-center justify-center"
                             style={{
                                 background: 'linear-gradient(135deg, #3E2723 0%, #2D1B15 100%)', // Dark Leather base
                                 boxShadow: 'inset 0 0 50px rgba(0,0,0,0.8), 0 10px 30px rgba(0,0,0,0.5)' // 3D Suspension + Depth
                             }}>
                            
                            {/* Texture Overlay */}
                            <div className="absolute inset-0 opacity-30 mix-blend-overlay pointer-events-none" style={{ backgroundImage: "url('https://www.transparenttextures.com/patterns/black-scales.png')" }}></div>

                            {/* Vintage Gold Embossed Border */}
                            <div className="absolute top-3 bottom-3 left-3 right-3 border-[6px] border-[#C5A059] rounded-sm pointer-events-none z-10"
                                 style={{
                                     boxShadow: 'inset 0 0 15px #000, 0 0 8px rgba(197, 160, 89, 0.6)',
                                     backgroundImage: 'linear-gradient(#C5A059, #C5A059), linear-gradient(#C5A059, #C5A059)',
                                     backgroundSize: '20px 2px, 2px 20px',
                                     backgroundPosition: '0 0, 0 0',
                                     backgroundRepeat: 'no-repeat'
                                 }}>
                                 {/* Decorative Corner Stars */}
                                 <Star size={24} className="absolute top-1 left-1 text-[#C5A059] -translate-x-1/2 -translate-y-1/2 fill-current" />
                                 <Star size={24} className="absolute top-1 right-1 text-[#C5A059] translate-x-1/2 -translate-y-1/2 fill-current" />
                                 <Star size={24} className="absolute bottom-1 left-1 text-[#C5A059] -translate-x-1/2 translate-y-1/2 fill-current" />
                                 <Star size={24} className="absolute bottom-1 right-1 text-[#C5A059] translate-x-1/2 translate-y-1/2 fill-current" />
                            </div>

                            {/* Content Container */}
                            <div className="relative z-20 flex flex-col items-center h-full justify-between py-16 w-3/4">

                                {/* Magic Title Section */}
                                <div className="flex flex-col items-center group cursor-default mt-8">
                                    <div className="relative">
                                        <h1 className="text-6xl md:text-7xl font-magic text-transparent bg-clip-text bg-gradient-to-b from-[#FFD700] via-[#FDB931] to-[#C0B283] drop-shadow-[0_4px_4px_rgba(0,0,0,0.8)] text-center leading-tight transition-all duration-300 group-hover:brightness-125 group-hover:drop-shadow-[0_0_10px_rgba(255,215,0,0.6)]">
                                            Â∞èÂè∂'s <br/> Memories
                                        </h1>
                                        {/* Hover Sparkles */}
                                        <div className="absolute inset-0 pointer-events-none overflow-visible">
                                           {Array.from({length: 8}).map((_, i) => (
                                              <motion.div 
                                                 key={i}
                                                 className="absolute text-yellow-200 text-xs opacity-0 group-hover:opacity-100"
                                                 style={{ top: `${Math.random()*100}%`, left: `${Math.random()*100}%` }}
                                                 animate={{ scale: [0, 1, 0], opacity: [0, 1, 0] }}
                                                 transition={{ duration: 1 + Math.random(), repeat: Infinity, delay: Math.random() }}
                                              >‚ú¶</motion.div>
                                           ))}
                                        </div>
                                    </div>
                                </div>

                                {/* Dynamic Cake Element */}
                                <div className="relative transform scale-110">
                                    <DynamicCake />
                                </div>

                                {/* Creamy Birthday Text */}
                                <div className="relative mb-4">
                                    <h2 className="text-5xl font-creamy text-[#FFFDD0] drop-shadow-[0_4px_0_rgba(139,69,19,0.5)] rotate-[-3deg] tracking-wide relative z-10">
                                        Happy Birthday
                                    </h2>
                                    {/* Shaking Sprinkles */}
                                    {Array.from({length: 12}).map((_, i) => (
                                        <motion.div 
                                            key={i}
                                            className="absolute w-2 h-2 rounded-full"
                                            style={{ 
                                                backgroundColor: ['#FF69B4', '#87CEEB', '#FFD700', '#98FB98'][i % 4],
                                                top: `${Math.random() * 100}%`, 
                                                left: `${Math.random() * 120 - 10}%`,
                                                zIndex: 0
                                            }}
                                            animate={{ x: [0, 2, -2, 0], y: [0, -2, 2, 0] }}
                                            transition={{ duration: 0.5, repeat: Infinity, repeatType: "mirror", delay: Math.random() }}
                                        />
                                    ))}
                                </div>

                                {/* Designer Footer */}
                                <div className="mb-4 text-[10px] font-sans font-bold tracking-[0.4em] text-[#C5A059]/60 uppercase border-t border-[#C5A059]/30 pt-2 w-1/2 text-center">
                                     DESIGNED BY Â∞èÈ©¨
                                </div>
                            </div>

                            {/* Corner Decorations */}
                            <img src={ASSETS.wizardHat} className="absolute top-6 right-6 w-16 opacity-90 rotate-12 drop-shadow-lg filter sepia-[0.3]" alt="Wizard Hat" />
                            <img src={ASSETS.magicCircle} className="absolute bottom-6 left-6 w-24 h-24 opacity-20 animate-spin-slow mix-blend-screen" alt="Magic Circle" />
                        </div>
                    </div>

                    {/* Page 1: Intro / Title Page */}
                    <div className="page">
                        <div className="page-content w-full h-full bg-[#FFF9E6]">
                            <div className="w-full h-full border-double border-4 border-[#8D6E63]/20 p-6 flex flex-col items-center justify-center text-center">
                                <h2 className="text-2xl font-cute text-[#5D4037] mb-6">Ëá¥ ÊúÄÂèØÁà±ÁöÑ‰Ω†</h2>
                                <p className="font-hand text-xl leading-loose text-[#8D6E63]">ÊÑø‰Ω†ÁöÑÁîüÊ¥ª<br/>Â¶ÇËøôÊú¨‰π¶È°µËà¨Á≤æÂΩ©<br/>ÊØè‰∏ÄÈ°µÈÉΩÊòØÊñ∞ÁöÑÁØáÁ´†<br/>ÊØè‰∏ÄÂàªÈÉΩÈó™Èó™ÂèëÂÖâ ‚ú®</p>
                                <div className="mt-8 opacity-80"><UsagiCharacter action="idle" className="w-32 h-32" /></div>
                            </div>
                        </div>
                    </div>
                    
                    {/* Dynamic Photo Pages */}
                    {pagesData.map((pageData, pageIndex) => (
                        <div key={`page-${pageIndex}`} className="page">
                            {/* Added padding (p-6) and paper color bg-[#FDF5E6] to look like a book */}
                            <div className="page-content w-full h-full bg-[#FDF5E6] p-6 flex flex-col shadow-inner relative"> 
                                
                                {/* Decorative Page Number */}
                                <div className="absolute bottom-3 right-4 text-[#8D6E63]/40 font-mono text-xs z-10">{pageIndex + 1}</div>

                                {pageData.type === 'landscape_pair' ? (
                                    <div className="flex flex-col w-full h-full gap-6 justify-center">
                                        {pageData.photos.map((photo, i) => (
                                            <div key={photo.id} className="relative group bg-white p-2 shadow-md hover:shadow-xl transition-all transform hover:-translate-y-1 rotate-1 border border-gray-100">
                                                 <div className="overflow-hidden aspect-[4/3] w-full relative">
                                                    <img src={photo.url} className="w-full h-full object-cover" loading="lazy" draggable="false" onClick={() => setActiveCaptionId(activeCaptionId === photo.id ? null : photo.id)}/>
                                                    <div className="absolute bottom-2 left-2 bg-black/40 text-white text-xs px-2 py-1 rounded backdrop-blur-md opacity-0 group-hover:opacity-100 transition-opacity">{photo.desc}</div>
                                                    {activeCaptionId === photo.id && <div className="absolute inset-0 bg-black/60 flex items-center justify-center text-white font-hand text-2xl p-4 text-center pointer-events-none">{photo.desc}</div>}
                                                 </div>
                                                 <div className="mt-2 text-center font-hand text-[#5D4037] text-lg">{photo.desc}</div>
                                            </div>
                                        ))}
                                    </div>
                                ) : (
                                    <div className="w-full h-full flex items-center justify-center p-2">
                                        <div className="relative group bg-white p-3 shadow-[0_4px_20px_rgba(0,0,0,0.1)] hover:shadow-2xl transition-all transform hover:scale-[1.02] -rotate-1 border border-gray-100 w-full">
                                            <div className="overflow-hidden aspect-[3/4] w-full relative border border-gray-50">
                                                <img src={pageData.photos[0].url} className="w-full h-full object-cover" loading="lazy" draggable="false" onClick={() => setActiveCaptionId(activeCaptionId === pageData.photos[0].id ? null : pageData.photos[0].id)} />
                                                {activeCaptionId === pageData.photos[0].id && <div className="absolute inset-0 bg-black/60 flex items-center justify-center text-white font-hand text-3xl p-4 text-center pointer-events-none">{pageData.photos[0].desc}</div>}
                                            </div>
                                            <div className="mt-4 text-center font-hand text-[#5D4037] text-2xl tracking-wide">{pageData.photos[0].desc}</div>
                                        </div>
                                    </div>
                                )}
                            </div>
                        </div>
                    ))}

                    {/* Back Cover - REDESIGNED */}
                    <div className="page hardcover" data-density="hard">
                        <div className="page-content w-full h-full relative overflow-hidden flex flex-col items-center justify-center bg-[#FDF5E6]">
                            {/* Inner Page Texture (Light Gold/Cream) */}
                            <div className="absolute inset-0 opacity-40 pointer-events-none" style={{ backgroundImage: "url('https://www.transparenttextures.com/patterns/cream-paper.png')" }}></div>
                            
                            {/* Falling Star Dust Animation */}
                            <div className="absolute inset-0 pointer-events-none overflow-hidden">
                                {Array.from({length: 15}).map((_, i) => (
                                    <motion.div
                                        key={i}
                                        className="absolute text-yellow-300 opacity-60 text-xs"
                                        style={{ top: -20, left: `${Math.random() * 100}%` }}
                                        animate={{ y: '110%', rotate: 360 }}
                                        transition={{ duration: 5 + Math.random() * 5, repeat: Infinity, delay: Math.random() * 5, ease: "linear" }}
                                    >
                                        ‚ú®
                                    </motion.div>
                                ))}
                            </div>

                            {/* Main Content Area */}
                            <div className="relative z-10 flex flex-col items-center justify-between h-full py-16 w-3/4">
                                
                                {/* Top Image Decoration */}
                                <div className="relative transform rotate-2 p-2 bg-white shadow-lg border border-[#F8C860]/30 mt-8 group hover:scale-105 transition-transform duration-300">
                                    <div className="absolute -top-3 left-1/2 -translate-x-1/2 w-8 h-8 bg-[#F06292]/20 rounded-full blur-xl"></div>
                                    <img src="https://test.fukit.cn/autoupload/f/IeSYb0Mnf1Z62nIKYGB4NyfNcKcqEnRmcljopnyJoMs/20251226/Gd2W/548X696/image.png/webp" 
                                         className="w-40 md:w-48 h-auto object-cover border border-gray-100" 
                                         alt="Memories" draggable="false" />
                                    {/* Washi Tape */}
                                    <div className="absolute -top-2 left-1/2 -translate-x-1/2 w-12 h-4 washi-tape opacity-80 rotate-1"></div>
                                </div>

                                {/* Text Content */}
                                <div className="text-center space-y-2">
                                    <h2 className="text-4xl md:text-5xl font-magic text-[#C5A059] drop-shadow-sm tracking-wide animate-pulse-slow relative">
                                        To Be Continued...
                                        <motion.span 
                                            className="absolute -right-6 top-0 text-2xl"
                                            animate={{ rotate: [0, 20, 0] }}
                                            transition={{ duration: 2, repeat: Infinity }}
                                        >ü™Ñ</motion.span>
                                    </h2>
                                    <p className="font-hand text-[#8D6E63] text-xl md:text-2xl mt-4 tracking-wider">
                                        ÊÑøÊØè‰∏™Êó•Â∏∏ÈÉΩÊúâÈ≠îÊ≥ï‚ú®
                                    </p>
                                </div>

                                {/* Interaction Buttons */}
                                <div className="flex flex-col gap-4 w-full items-center mb-8">
                                    {/* Return to Cover Button */}
                                    <button 
                                        onClick={() => goToPage(0)} 
                                        className="group relative px-7 py-1 bg-gradient-to-r from-[#F8C860] to-[#F9D59B] text-[#5D4037] font-bold rounded-full shadow-lg border-2 border-[#FFF] hover:shadow-xl hover:-translate-y-1 transition-all flex items-center gap-2 overflow-hidden"
                                    >
                                        <div className="absolute inset-0 bg-white/20 translate-x-[-100%] group-hover:translate-x-[100%] transition-transform duration-500 skew-x-12"></div>
                                        <span className="text-xl">ü™Ñ</span>
                                        <span className="font-cute tracking-wide">ËøîÂõûÂ∞ÅÈù¢</span>
                                    </button>

                                    {/* Next Chapter (Original functionality preserved but restyled) */}
                                    { !isBackgroundMode && (
                                        <button 
                                            onClick={onNext} 
                                            className="text-[#F06292] font-hand font-bold text-lg hover:text-[#E91E63] hover:underline decoration-wavy underline-offset-4 transition-all flex items-center gap-1 opacity-80 hover:opacity-100"
                                        >
                                            Next Chapter <Heart size={14} fill="currentColor" />
                                        </button>
                                    )}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            {/* Controls & UI Overlay - CENTERED & ENHANCED */}
            {!isBackgroundMode && isLoaded && (
                <>
                    <div 
                        className="fixed bottom-6 left-1/2 z-40 bg-white/80 backdrop-blur-md px-6 py-2 rounded-full shadow-lg flex items-center gap-4 text-[#5D4037] text-sm"
                        style={{ transform: 'translateX(-50%)' }}
                    >
                        <button onClick={goPrev} className="hover:text-usagi-orange transition-colors"><ChevronLeft size={20}/></button>
                        <span className="font-mono min-w-[80px] text-center">Page {currentPage} / {totalPages}</span>
                        <button onClick={goNext} className="hover:text-usagi-orange transition-colors"><ChevronRight size={20}/></button>
                        
                        <div className="h-4 w-px bg-[#5D4037]/20 mx-2"></div>
                        <button onClick={() => setShowThumbnails(true)} className="hover:text-usagi-orange transition-colors" title="Gallery"><Grid size={18} /></button>
                    </div>
                    <AnimatePresence>
                        {showThumbnails && (
                            <>
                                <motion.div initial={{ opacity: 0 }} animate={{ opacity: 1 }} exit={{ opacity: 0 }} className="fixed inset-0 z-[50] bg-black/20 backdrop-blur-sm" onClick={() => setShowThumbnails(false)}/>
                                <motion.div initial={{ x: '100%' }} animate={{ x: 0 }} exit={{ x: '100%' }} transition={{ type: 'spring', damping: 25, stiffness: 200 }} className="fixed right-0 top-0 bottom-0 w-64 md:w-80 bg-[#FFF9E6] shadow-2xl z-[51] flex flex-col border-l-4 border-[#8D6E63]">
                                    <div className="p-4 border-b border-[#8D6E63]/20 flex justify-between items-center bg-[#5D4037] text-[#F9D59B]"><h3 className="font-bold text-lg flex items-center gap-2"><ImageIcon size={18}/> Gallery</h3><button onClick={() => setShowThumbnails(false)}><X size={20}/></button></div>
                                    <div className="flex-1 overflow-y-auto p-4 grid grid-cols-2 gap-4 content-start">
                                        <div onClick={() => goToPage(0)} className="cursor-pointer hover:opacity-80 transition-opacity"><div className="aspect-[3/4] bg-[#5D4037] rounded shadow-md flex items-center justify-center text-[#F9D59B] text-xs p-2 text-center border-2 border-[#3E2723]">Cover</div><div className="text-center text-xs mt-1 text-[#5D4037]">Cover</div></div>
                                        {pagesData.map((p, i) => (<div key={i} onClick={() => goToPage(i + 2)} className="cursor-pointer hover:opacity-80 transition-opacity"><div className="aspect-[3/4] bg-white rounded shadow-md overflow-hidden border border-[#8D6E63]/20 p-1 flex items-center justify-center bg-gray-100"><span className="text-xs text-gray-400">Page {i+1}</span></div><div className="text-center text-xs mt-1 text-[#5D4037]">Page {i+1}</div></div>))}
                                    </div>
                                </motion.div>
                            </>
                        )}
                    </AnimatePresence>
                </>
            )}
            {!isLoaded && (<div className="absolute inset-0 flex items-center justify-center z-50"><div className="w-16 h-16 border-4 border-usagi-main border-t-transparent rounded-full animate-spin"></div></div>)}
          </div>
        );
      };

      // Scene Vinyl Player (OPTIMIZED)
      const SceneVinylPlayer = () => {
        const PLAYLIST = [
           { title: "Á∫¢Ëâ≤È´òË∑üÈûã", artist: "Ëî°ÂÅ•ÈõÖ", url: "https://audio.fukit.cn/autoupload/f/IeSYb0Mnf1Z62nIKYGB4NyfNcKcqEnRmcljopnyJoMs/20251215/Wahg/42651_LOW_20250602141342_1_206013_M017967.mp3" },
           { title: "Á∫¢Êò≠ÊÑø", artist: "Èü≥ÈòôËØóÂê¨", url: "https://audio.fukit.cn/autoupload/f/IeSYb0Mnf1Z62nIKYGB4NyfNcKcqEnRmcljopnyJoMs/20251216/T5aQ/42651_LOW_20250602144812_206025_lx144476.mp3" },
           { title: "ÊàëÂ•ΩÂÉèÂú®Âì™ËßÅËøá‰Ω†", artist: "Ëñõ‰πãË∞¶", url: "https://audio.fukit.cn/autoupload/f/IeSYb0Mnf1Z62nIKYGB4NyfNcKcqEnRmcljopnyJoMs/20251216/v39p/42651_LOW_20250602150554_206030_mk127870.mp3" }
        ];

        const [isPlaying, setIsPlaying] = useState(false);
        const [trackIndex, setTrackIndex] = useState(0);
        const [volume, setVolume] = useState(0.7);
        const [currentTime, setCurrentTime] = useState(0);
        const [duration, setDuration] = useState(0);
        
        const canvasRef = useRef(null);
        const audioRef = useRef(null);
        const rafId = useRef(null);

        const currentTrack = PLAYLIST[trackIndex].url;
        const currentTitle = PLAYLIST[trackIndex].title;

        // Helper to format time
        const formatTime = (time) => {
          if (isNaN(time)) return "0:00";
          const minutes = Math.floor(time / 60);
          const seconds = Math.floor(time % 60);
          return `${minutes}:${seconds < 10 ? '0' : ''}${seconds}`;
        };

        // Handle Audio Playback Toggle - DIRECT CONTROL
        const togglePlay = () => {
            if(!audioRef.current) return;
            if (audioRef.current.paused) {
                audioRef.current.play().catch(e => console.error("Playback failed", e));
            } else {
                audioRef.current.pause();
            }
        };

        const nextTrack = () => {
             setTrackIndex(prev => (prev + 1) % PLAYLIST.length);
             // Logic to auto-play new track handled by useEffect on trackIndex or autoPlay attribute
        };

        const prevTrack = () => {
             setTrackIndex(prev => (prev - 1 + PLAYLIST.length) % PLAYLIST.length);
        };

        // Auto-play when track changes if it was already playing or just started
        useEffect(() => {
             if(audioRef.current) {
                 const playPromise = audioRef.current.play();
                 if (playPromise !== undefined) {
                     playPromise.catch(e => {
                         // Auto-play might be blocked if no user interaction yet in this specific context, 
                         // but usually fine if user clicked "Next"
                         console.log("Auto-play prevented");
                     });
                 }
             }
        }, [trackIndex]);

        // Volume Sync
        useEffect(() => {
            if(audioRef.current) audioRef.current.volume = volume;
        }, [volume]);

        const handleTimeUpdate = () => {
            if (audioRef.current) setCurrentTime(audioRef.current.currentTime);
        };
        
        const handleLoadedMetadata = () => {
            if (audioRef.current) setDuration(audioRef.current.duration);
        };
        
        const handleSeek = (e) => {
            const time = parseFloat(e.target.value);
            if (audioRef.current) {
                audioRef.current.currentTime = time;
                setCurrentTime(time);
            }
        };

        // Bind Audio Events to State
        const onAudioPlay = () => setIsPlaying(true);
        const onAudioPause = () => setIsPlaying(false);

        // Simulated Visualizer Loop
        useEffect(() => {
          if (!canvasRef.current) return;
          const canvas = canvasRef.current;
          const ctx = canvas.getContext('2d');
          const bufferLength = 64; 
          const dataArray = new Uint8Array(bufferLength);
          
          const centerX = canvas.width / 2;
          const centerY = canvas.height / 2;
          const radius = Math.min(canvas.width, canvas.height) / 3.5; 

          const draw = () => {
            rafId.current = requestAnimationFrame(draw);
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            if (isPlaying) {
               const time = Date.now() / 1000;
               for(let i=0; i<bufferLength; i++) {
                   const noise = Math.sin(i * 0.2 + time * 5) * 50 + Math.cos(i * 0.5 - time * 3) * 30;
                   const beat = (Math.sin(time * 8) + 1) * 20; 
                   dataArray[i] = Math.max(10, Math.abs(noise) + beat + Math.random() * 20);
               }
            } else {
               dataArray.fill(5); 
            }

            // Draw visualizer
            ctx.beginPath();
            for (let i = 0; i < bufferLength; i++) {
                const barHeight = dataArray[i] * 0.8;
                const angle = (i * Math.PI * 2) / bufferLength;
                const x1 = centerX + Math.cos(angle) * radius;
                const y1 = centerY + Math.sin(angle) * radius;
                const x2 = centerX + Math.cos(angle) * (radius + barHeight);
                const y2 = centerY + Math.sin(angle) * (radius + barHeight);
                ctx.moveTo(x1, y1);
                ctx.lineTo(x2, y2);
            }
            ctx.strokeStyle = '#FBBF77'; 
            ctx.lineWidth = 3;
            ctx.lineCap = 'round';
            ctx.stroke();
          };
          draw();
          return () => cancelAnimationFrame(rafId.current);
        }, [isPlaying]);

        return (
          <div className="relative w-full h-screen bg-vinyl-bg flex flex-col items-center justify-center overflow-hidden">
             {/* 1. Background: Texture & Scratches */}
             <div className="absolute inset-0 bg-scratched opacity-20 pointer-events-none mix-blend-overlay"></div>
             <div className="absolute inset-0 bg-gradient-to-t from-black/90 to-transparent pointer-events-none"></div>
             {/* Floating Notes */}
             {isPlaying && (
                <div className="absolute inset-0 pointer-events-none overflow-hidden">
                   {Array.from({length: 10}).map((_,i) => (
                      <motion.div 
                         key={i}
                         className="absolute text-usagi-gold text-4xl opacity-0"
                         initial={{ x: Math.random() * window.innerWidth, y: window.innerHeight }}
                         animate={{ y: -100, x: (Math.random() - 0.5) * 200 + window.innerWidth/2, opacity: [0, 1, 0], rotate: [0, 20, -20] }}
                         transition={{ duration: 4, repeat: Infinity, delay: Math.random() * 5, ease: "linear" }}
                      >
                         ‚ô™
                      </motion.div>
                   ))}
                </div>
             )}
             {/* 2. Warm Yellow Glow Animation */}
             <motion.div 
               className="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-[60vw] h-[60vw] bg-[#ffb74d] rounded-full blur-[100px] pointer-events-none"
               animate={{ 
                 opacity: isPlaying ? [0.1, 0.25, 0.1] : 0,
                 scale: isPlaying ? [1, 1.2, 1] : 0.8 
               }}
               transition={{ duration: 4, repeat: Infinity, ease: "easeInOut" }}
             />

             {/* Main Turntable Unit */}
             <div className="relative z-10 w-[95%] max-w-2xl aspect-square md:aspect-[4/3] bg-[#4E342E] rounded-3xl shadow-vinyl border-t border-white/10 flex flex-col items-center justify-center p-8 overflow-hidden group">
                <div className="absolute inset-0 bg-wood-pattern opacity-40 mix-blend-multiply pointer-events-none rounded-3xl"></div>
                
                {/* Visualizer Canvas Layer */}
                <canvas ref={canvasRef} width={800} height={800} className="absolute inset-0 w-full h-full pointer-events-none opacity-50 mix-blend-screen" />

                {/* Turntable Platter */}
                <div className="relative w-[280px] h-[280px] md:w-[380px] md:h-[380px] rounded-full bg-[#111] shadow-2xl flex items-center justify-center border-4 border-[#222]">
                   
                   {/* The Record - Slow Spin */}
                   <motion.div 
                      className={`relative w-[95%] h-[95%] rounded-full vinyl-record flex items-center justify-center overflow-hidden border border-black/50`}
                      animate={isPlaying ? { rotate: 360 } : { rotate: 0 }}
                      transition={isPlaying ? { repeat: Infinity, duration: 4, ease: "linear" } : { duration: 0.5 }}
                   >
                      <div className="absolute inset-0 grooves"></div>
                      <div className="absolute inset-0 bg-gradient-to-tr from-white/10 to-transparent rounded-full pointer-events-none"></div>
                      
                      {/* Record Label */}
                      <div className="w-[35%] h-[35%] bg-usagi-pink rounded-full flex items-center justify-center shadow-lg border-2 border-white/20 relative z-20">
                         <img src="https://test.fukit.cn/autoupload/f/IeSYb0Mnf1Z62nIKYGB4NyfNcKcqEnRmcljopnyJoMs/20251214/P3yB/4272X4300/mai.png/webp" className="w-[80%] h-[80%] object-cover rounded-full" alt="Album Art" />
                         <div className="absolute w-2 h-2 bg-black rounded-full top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2"></div>
                      </div>
                   </motion.div>
                </div>

                {/* Tone Arm - Jumping Animation */}
                <div className="absolute top-[8%] right-[4%] w-24 h-64 md:w-32 md:h-80 pointer-events-none z-30">
                    <div className="absolute top-4 right-4 w-12 h-12 rounded-full bg-gradient-to-b from-[#888] to-[#444] shadow-lg flex items-center justify-center border border-white/20">
                       <div className="w-6 h-6 rounded-full bg-[#222] border border-white/10"></div>
                    </div>
                    
                    <motion.div 
                       className="absolute top-10 right-10 w-6 h-[80%] bg-[#ccc] origin-top rounded-full shadow-xl border-l border-white/50 arm-shadow"
                       style={{ transformOrigin: "50% 12px" }}
                       animate={{ 
                         rotate: isPlaying ? 32 : 0,
                         y: isPlaying ? [0, 1.5, 0] : 0 // Needle bouncing
                       }}
                       transition={{ 
                         rotate: { duration: 1, type: "spring" },
                         y: { duration: 0.4, repeat: Infinity, repeatType: "mirror", ease: "easeInOut" } // Rhythm bounce
                       }}
                    >
                       <div className="w-full h-full bg-gradient-to-r from-[#ddd] via-[#fff] to-[#999] rounded-full"></div>
                       <div className="absolute bottom-0 left-1/2 -translate-x-1/2 w-8 h-10 bg-black rounded-sm border-t-2 border-usagi-gold shadow-lg"></div>
                    </motion.div>
                </div>

                {/* Controls Area */}
                <div className="absolute bottom-0 left-0 w-full h-32 bg-black/60 backdrop-blur-md border-t border-white/10 flex flex-col justify-center px-6 md:px-10 py-4 gap-2 z-40">
                   
                   {/* Progress Bar */}
                   <div className="w-full flex items-center gap-3 text-xs font-mono text-[#d4af37]">
                      <span className="w-8 text-right">{formatTime(currentTime)}</span>
                      <input 
                         type="range" 
                         min="0" max={duration || 100} step="0.1"
                         value={currentTime} 
                         onChange={handleSeek}
                         className="flex-1 h-1.5 bg-white/20 rounded-lg appearance-none cursor-pointer accent-[#d4af37]"
                      />
                      <span className="w-8">{formatTime(duration)}</span>
                   </div>

                   <div className="flex items-center justify-between w-full">
                       {/* Playback Controls */}
                       <div className="flex items-center gap-4">
                          <motion.button onClick={prevTrack} whileTap={{ scale: 0.9 }} className="text-white/60 hover:text-white"><SkipBack /></motion.button>
                          <motion.button 
                             whileTap={{ scale: 0.9 }} 
                             onClick={togglePlay}
                             className={`w-10 h-10 md:w-12 md:h-12 rounded-full flex items-center justify-center text-black shadow-lg ${isPlaying ? 'bg-usagi-orange' : 'bg-white'}`}
                          >
                             {isPlaying ? <Pause fill="currentColor" /> : <Play fill="currentColor" className="ml-1" />}
                          </motion.button>
                          <motion.button onClick={nextTrack} whileTap={{ scale: 0.9 }} className="text-white/60 hover:text-white"><SkipForward /></motion.button>
                       </div>

                       {/* Song Info (No Upload Button) */}
                       <div className="flex-1 mx-4 md:mx-8 flex flex-col justify-center items-center">
                          <div className="text-usagi-gold font-hand text-lg md:text-xl truncate w-full text-center">{currentTitle}</div>
                       </div>

                       {/* Volume Control */}
                       <div className="flex items-center gap-2 w-24 md:w-32">
                          <Volume2 size={16} className="text-white/60" />
                          <input 
                             type="range" 
                             min="0" max="1" step="0.01" 
                             value={volume} 
                             onChange={(e) => setVolume(parseFloat(e.target.value))}
                             className="w-full h-1 bg-white/20 rounded-lg appearance-none cursor-pointer accent-usagi-orange"
                          />
                       </div>
                   </div>
                </div>
             </div>
             
             <audio 
                ref={audioRef} 
                src={currentTrack} 
                preload="auto"
                loop 
                onTimeUpdate={handleTimeUpdate}
                onLoadedMetadata={handleLoadedMetadata}
                onPlay={onAudioPlay}
                onPause={onAudioPause}
                onEnded={() => setIsPlaying(false)}
             />
          </div>
        );
      };

      // SCENE 3: Wishes (Modified with Tape, Stickers, and New Button)
      const Scene3Wishes = ({ onGoToCakeInteraction, onGoToOutro, onGoToVinyl }) => {
        const letterChars = BIRTHDAY_LETTER.split('');
        const [isWishHovered, setIsWishHovered] = useState(false);

        const handleGiftClick = () => {
          // Navigate to Vinyl Player instead of just confetti
          onGoToVinyl();
        };

        const containerVariants = {
          hidden: { opacity: 0 },
          visible: {
            opacity: 1,
            transition: { 
               delayChildren: 4.0, 
               staggerChildren: 0.1 
            } 
          }
        };

        const charVariants = {
          hidden: { opacity: 0, y: 5 },
          visible: { opacity: 1, y: 0, transition: { duration: 0.1 } }
        };

        return (
          <div className="relative min-h-screen w-full flex items-center justify-center p-4 md:p-8 overflow-hidden">
            <FallingPetals />
            <AtmosphereParticles />
            
            {/* Added Mini Planner Decorations */}
            <motion.img 
              src="https://test.fukit.cn/autoupload/f/IeSYb0Mnf1Z62nIKYGB4NyfNcKcqEnRmcljopnyJoMs/20251214/TGpb/4320X4992/shengri.png/webp" 
              alt="Decoration" 
              className="absolute bottom-4 right-4 w-32 md:w-56 z-10 pointer-events-none"
              initial={{ opacity: 0 }} 
              animate={{ opacity: 1, y: [0, -10, 0] }}
              transition={{ 
                opacity: { duration: 1.0 }, 
                y: { repeat: Infinity, duration: 4, ease: "easeInOut" }
              }}
            />

            <div className="relative z-20 w-full max-w-6xl grid grid-cols-1 md:grid-cols-2 gap-10 items-center">
              
              <div className="relative w-full">
                  {/* Decorative Elements around Card */}
                  <div className="absolute -top-4 -left-4 z-30 text-4xl transform -rotate-12 animate-bounce-slow">‚ú®</div>
                  <div className="absolute -top-1 -right-8 z-30 text-3xl transform rotate-12 animate-pulse">üå∏</div>               
                  <motion.img 
                     src="https://test.fukit.cn/autoupload/f/IeSYb0Mnf1Z62nIKYGB4NyfNcKcqEnRmcljopnyJoMs/20251214/LCWH/5008X4320/xingfu.png/webp" 
                     alt="Happiness" 
                     className="absolute -top-6 -right-6 w-24 md:w-32 z-50 drop-shadow-md pointer-events-none origin-center"
                     style={{ transform: 'translate(1cm, -1cm) scale(1.5) rotate(12deg)' }}
                     initial={{ opacity: 0 }}
                     animate={{ opacity: 1 }}
                     transition={{ duration: 1.0 }}
                  />
                  
                  <motion.img 
                     src="https://test.fukit.cn/autoupload/f/IeSYb0Mnf1Z62nIKYGB4NyfNcKcqEnRmcljopnyJoMs/20251214/JCAe/8000X5520/kuang.png/webp" 
                     alt="Frame" 
                     className="absolute -bottom-13 -left-12 w-[130%] max-w-none z-50 pointer-events-none"
                     style={{ transform: 'translate(-1cm, 2.5cm)' }}
                     initial={{ opacity: 0 }}
                     animate={{ opacity: 1 }}
                     transition={{ duration: 1.0 }}
                  />

                  <motion.div 
                    initial={{ x: -30, opacity: 0 }} 
                    animate={{ x: 0, opacity: 1 }} 
                    transition={{ delay: 3.0, duration: 1.0, ease: "easeOut" }}
                    className="w-full bg-gradient-to-b from-[#FFF9E6]/80 to-[#FFF9E6]/40 backdrop-blur-[5px] border border-white/40 shadow-soft p-8 md:p-12 rounded-2xl relative flex flex-col justify-between min-h-[420px]"
                  >
                    {/* Washi Tape Decorations */}
                    <div className="absolute -top-3 left-10 w-24 h-8 washi-tape rotate-[-2deg] z-20" style={{ clipPath: 'polygon(0% 0%, 100% 0%, 98% 100%, 2% 100%)' }}></div>
                    <div className="absolute -bottom-3 right-10 w-20 h-8 washi-tape rotate-[3deg] z-20" style={{ clipPath: 'polygon(2% 0%, 98% 0%, 100% 100%, 0% 100%)' }}></div>
                    
                    <div className="flex items-center gap-3 mb-8 relative z-10">
                      <motion.h2 
                        className="text-[28px] md:text-3xl font-cute font-bold text-[#F06292] tracking-wide title-glow"
                        animate={{ y: [0, -3, 0] }}
                        transition={{ duration: 2, repeat: Infinity, ease: "easeInOut" }}
                      >
                        Á•ù{RECIPIENT_NAME}ÁîüÊó•Âø´‰πêÔºÅ
                      </motion.h2>
                      <motion.div 
                        className="w-12 h-12 -mt-2"
                        animate={{ rotate: [0, 10, -10, 0] }}
                        transition={{ duration: 2, repeat: Infinity }}
                      >
                        <UsagiCharacter action="cheer" className="w-full h-full" />
                      </motion.div>
                    </div>

                    <motion.div 
                      className="font-cute text-xl md:text-2xl text-[#5D4037] leading-[1.8] tracking-wide flex-grow relative z-10 whitespace-pre-wrap"
                      variants={containerVariants}
                      initial="hidden"
                      animate="visible"
                    >
                      {letterChars.map((char, i) => (
                        <motion.span key={i} variants={charVariants} className={/[a-zA-Z]/.test(char) ? "font-sans font-medium" : ""}>
                          {char}
                        </motion.span>
                      ))}
                    </motion.div>

                    <div className="mt-8 flex justify-end relative z-10" style={{ transform: 'translate(-1cm, -1cm)' }}>
                      <span className="text-sm font-sans text-gray-500/80 tracking-widest uppercase">
                        From {SENDER_NAME}
                      </span>
                    </div>
                  </motion.div>
              </div>

              <div className="flex flex-col items-center gap-8 relative">
                
                <motion.div 
                  className="relative cursor-pointer group" 
                  onClick={onGoToCakeInteraction} 
                  whileHover={{ y: -5, filter: "drop-shadow(0 10px 10px rgba(0,0,0,0.1))" }}
                  whileTap={{ scale: 0.95 }}
                  transition={{ type: "spring", stiffness: 300 }}
                >
                  <div className="text-[8rem] md:text-[9rem] leading-none transition-transform group-hover:rotate-3">üéÇ</div>
                  <span className="absolute -bottom-2 left-1/2 -translate-x-1/2 bg-white/90 px-4 py-1.5 rounded-full text-xs font-bold text-usagi-text opacity-0 group-hover:opacity-100 transition-opacity shadow-sm whitespace-nowrap border border-usagi-orange/20">
                    ÂêÉÊàëÂêÉÊàëüòä
                  </span>
                </motion.div>

                <motion.div 
                  className="relative cursor-pointer group" 
                  onClick={handleGiftClick} 
                  whileHover={{ y: -5, rotate: [0, -5, 5, 0], filter: "drop-shadow(0 10px 10px rgba(0,0,0,0.1))" }}
                  whileTap={{ scale: 0.95 }}
                >
                  <div className="text-7xl md:text-8xl filter brightness-105">üéÅ</div>
                  
                  <motion.div 
                     className="absolute -top-8 left-1/2 -translate-x-1/2 opacity-0 group-hover:opacity-100 transition-all duration-300 pointer-events-none"
                     initial={{ y: 5 }}
                     whileHover={{ y: -5 }}
                  >
                     <div className="bg-white px-3 py-1 rounded-full shadow-lg border border-usagi-orange/30 text-usagi-text text-sm font-bold whitespace-nowrap flex items-center gap-1">
                        Á≠â‰Ω†Â•Ω‰πÖÂï¶üòâ
                     </div>
                     <div className="w-2 h-2 bg-white transform rotate-45 absolute -bottom-1 left-1/2 -translate-x-1/2 border-b border-r border-usagi-orange/30"></div>
                  </motion.div>
                </motion.div>

                {/* --- Updated "Make a Wish" Button --- */}
                <motion.button 
                  onClick={onGoToOutro} 
                  onMouseEnter={() => setIsWishHovered(true)}
                  onMouseLeave={() => setIsWishHovered(false)}
                  whileHover={{ scale: 1.05 }}
                  whileTap={{ scale: 0.95, y: 4, boxShadow: "0 0 0 transparent" }}
                  className="mt-6 relative bg-gradient-to-r from-[#FFCC80] to-[#FFAB91] text-white font-bold text-xl md:text-2xl py-4 px-10 rounded-[2rem] shadow-[0_6px_0_rgba(0,0,0,0.1)] border-4 border-white transition-all flex items-center justify-center gap-2 font-cute group overflow-visible min-w-[240px] hover:translate-y-[-2px] hover:shadow-[0_8px_0_rgba(0,0,0,0.1)] active:translate-y-[2px] active:shadow-[0_2px_0_rgba(0,0,0,0.1)]"
                >
                  {/* Inner Content */}
                  <AnimatePresence mode="wait">
                      {isWishHovered ? (
                          <motion.div 
                              key="hovered" 
                              initial={{ opacity: 0, y: 5 }} 
                              animate={{ opacity: 1, y: 0 }} 
                              exit={{ opacity: 0, y: -5 }}
                              className="flex items-center gap-2"
                          >
                              <span>ÊÑøÊúõÊ≠£Âú®Âä†ËΩΩ~</span>
                              <motion.span animate={{ rotate: 360 }} transition={{ duration: 1, repeat: Infinity, ease: "linear" }}>üí´</motion.span>
                          </motion.div>
                      ) : (
                          <motion.div 
                              key="normal" 
                              initial={{ opacity: 0, y: 5 }} 
                              animate={{ opacity: 1, y: 0 }} 
                              exit={{ opacity: 0, y: -5 }}
                              className="flex items-center gap-2"
                          >
                              <span className="relative z-10">Make a wish</span>
                              <ArrowRight size={20} className="relative z-10" />
                          </motion.div>
                      )}
                  </AnimatePresence>
                  
                  {/* Hover Particles */}
                  <AnimatePresence>
                      {isWishHovered && (
                          <>
                             {Array.from({length: 6}).map((_, i) => (
                                 <motion.div
                                     key={i}
                                     initial={{ opacity: 0, scale: 0, x: 0, y: 0 }}
                                     animate={{ 
                                         opacity: [0, 1, 0], 
                                         scale: [0.5, 1, 0.5], 
                                         x: (Math.random() - 0.5) * 60, 
                                         y: -20 - Math.random() * 30 
                                     }}
                                     exit={{ opacity: 0 }}
                                     transition={{ duration: 0.8, repeat: Infinity, delay: i * 0.1 }}
                                     className="absolute top-0 left-1/2 -translate-x-1/2 text-pink-500 text-sm pointer-events-none"
                                 >
                                     ‚ù§Ô∏è
                                 </motion.div>
                             ))}
                          </>
                      )}
                  </AnimatePresence>
                </motion.button>

              </div>
            </div>
          </div>
        );
      };

      // SCENE 4: Cake Interaction
      const Scene4CakeInteraction = () => {
        const containerRef = useRef(null);
        const videoRef = useRef(null);
        const rendererRef = useRef(null);
        const particlesRef = useRef(null);
        const cameraRef = useRef(null);
        const controlsRef = useRef(null);
        const handsRef = useRef(null);
        const streamRef = useRef(null);
        const cameraActive = useRef(false);
        const analyserRef = useRef(null);
        const lastActionTime = useRef(0);
        const blowTriggerCount = useRef(0);
        const audioCheckRaf = useRef(0);

        const [cakeState, setCakeState] = useState('SCATTERED');
        const [cameraAuthorized, setCameraAuthorized] = useState(false);
        const [cameraError, setCameraError] = useState(null);
        const [micActive, setMicActive] = useState(false);
        const [feedback, setFeedback] = useState(null);
        const [detectedGesture, setDetectedGesture] = useState('Searching...');
        const [handVisible, setHandVisible] = useState(false);
        const [surpriseActive, setSurpriseActive] = useState(false);

        const stateRef = useRef({ cakeState, surpriseActive });
        useEffect(() => { stateRef.current = { cakeState, surpriseActive }; }, [cakeState, surpriseActive]);

        const stopCamera = useCallback(() => {
             cameraActive.current = false;
             if (streamRef.current) {
                streamRef.current.getTracks().forEach(track => {
                    try { track.stop(); } catch(e) {}
                });
                streamRef.current = null;
             }
             if (videoRef.current) {
                videoRef.current.srcObject = null;
             }
             if (handsRef.current) {
                try { handsRef.current.close(); } catch(e) {}
                handsRef.current = null;
             }
        }, []);

        const CONFIG = useMemo(() => ({
          particleCount: 35000,
          colors: { base: new THREE.Color('#F9D59B'), cream: new THREE.Color('#FFF8E1'), candle: new THREE.Color('#E0C097'), wick: new THREE.Color('#5D4037'), flameCore: new THREE.Color('#FFFFFF'), flameOuter: new THREE.Color('#FBBF77'), heart: new THREE.Color('#FF69B4'), heartGlow: new THREE.Color('#FFC0CB') },
          thresholds: { pinchDist: 0.05, audioLevel: 45 } 
        }), []);

        useEffect(() => {
          if (!containerRef.current) return;
          const scene = new THREE.Scene();
          const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 100);
          camera.position.set(0, 0, 14); camera.lookAt(0, 0, 0); cameraRef.current = camera;
          const renderer = new THREE.WebGLRenderer({ alpha: true, antialias: true });
          renderer.setSize(window.innerWidth, window.innerHeight);
          renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
          containerRef.current.appendChild(renderer.domElement);
          rendererRef.current = renderer;
          const controls = new OrbitControls(camera, renderer.domElement);
          controls.enableDamping = true; controls.dampingFactor = 0.05; controls.autoRotate = true; controls.autoRotateSpeed = 2.0; controls.enableZoom = false; controls.enablePan = false;
          controlsRef.current = controls;

          const positions = new Float32Array(CONFIG.particleCount * 3);
          const targets = new Float32Array(CONFIG.particleCount * 3);
          const heartTargets = new Float32Array(CONFIG.particleCount * 3);
          const colors = new Float32Array(CONFIG.particleCount * 3);
          const sizes = new Float32Array(CONFIG.particleCount);
          const types = new Float32Array(CONFIG.particleCount);
          const CAKE_SCALE = 1.5;

          for (let i = 0; i < CONFIG.particleCount; i++) {
            const i3 = i * 3;
            const r = 25 * Math.cbrt(Math.random()); const theta = Math.random() * Math.PI * 2; const phi = Math.acos(2 * Math.random() - 1);
            positions[i3] = r * Math.sin(phi) * Math.cos(theta); positions[i3 + 1] = r * Math.sin(phi) * Math.sin(theta); positions[i3 + 2] = r * Math.cos(phi);
            
            const rand = Math.random(); let color = new THREE.Color(); let type = 0; let size = Math.random() * 0.5 + 0.8; let tx = 0, ty = 0, tz = 0; const yOffset = -0.5;
            if (rand < 0.65) {
              const noise = (Math.random() - 0.5) * 0.1;
              if (Math.random() > 0.4) { const rad = Math.sqrt(Math.random()) * 3.5; const ang = Math.random() * Math.PI * 2; const h = (Math.random() - 0.5) * 1.5; tx = Math.cos(ang) * rad; ty = h - 1.0; tz = Math.sin(ang) * rad; size = 1.5; }
              else { const rad = Math.sqrt(Math.random()) * 2.2; const ang = Math.random() * Math.PI * 2; const h = (Math.random() - 0.5) * 1.2; tx = Math.cos(ang) * rad; ty = h + 0.5; tz = Math.sin(ang) * rad; size = 1.4; }
              color = CONFIG.colors.base.clone().offsetHSL(0, 0, noise);
            } else if (rand < 0.88) {
              const rad = Math.sqrt(Math.random()) * 2.3; const ang = Math.random() * Math.PI * 2; let h = 0.5; if (Math.random() > 0.7) h -= Math.random() * 0.6; tx = Math.cos(ang) * rad; ty = h + 1.1; tz = Math.sin(ang) * rad; color = CONFIG.colors.cream; size = 1.6;
            } else if (rand < 0.97) {
              const rad = Math.random() * 0.15; const ang = Math.random() * Math.PI * 2; const h = Math.random() * 1.5; tx = Math.cos(ang) * rad; ty = h + 1.8; tz = Math.sin(ang) * rad; color = CONFIG.colors.candle; size = 1.2;
            } else {
              if (Math.random() > 0.3) { tx = 0; ty = 3.4 + Math.random() * 0.1; tz = 0; color = CONFIG.colors.wick; type = 1; }
              else { const rad = Math.random() * 0.2; const ang = Math.random() * Math.PI * 2; const h = Math.random() * 0.5; const shape = (1 - h/0.5); tx = Math.cos(ang) * rad * shape; ty = 3.5 + h; tz = Math.sin(ang) * rad * shape; color = Math.random() > 0.5 ? CONFIG.colors.flameOuter : CONFIG.colors.flameCore; type = 2; size = 2.5; }
            }
            tx *= CAKE_SCALE; ty *= CAKE_SCALE; tz *= CAKE_SCALE; ty += yOffset;
            targets[i3] = tx; targets[i3+1] = ty; targets[i3+2] = tz;
            colors[i3] = color.r; colors[i3+1] = color.g; colors[i3+2] = color.b; sizes[i] = size; types[i] = type;

            const t = Math.random() * Math.PI * 2;
            let hx = 16 * Math.pow(Math.sin(t), 3); let hy = 13 * Math.cos(t) - 5 * Math.cos(2*t) - 2 * Math.cos(3*t) - Math.cos(4*t);
            const scale = 0.65; hx *= scale; hy *= scale;
            const thickness = 0.6; const randR = Math.random() * thickness; const randAng = Math.random() * Math.PI * 2;
            hx += Math.cos(randAng) * randR; hy += Math.sin(randAng) * randR; const hz = Math.sin(randAng) * randR * 2.0;
            heartTargets[i3] = hx; heartTargets[i3+1] = hy; heartTargets[i3+2] = hz;
          }

          const geometry = new THREE.BufferGeometry();
          geometry.setAttribute('position', new THREE.BufferAttribute(positions, 3));
          geometry.setAttribute('target', new THREE.BufferAttribute(targets, 3));
          geometry.setAttribute('heartTarget', new THREE.BufferAttribute(heartTargets, 3));
          geometry.setAttribute('color', new THREE.BufferAttribute(colors, 3));
          geometry.setAttribute('size', new THREE.BufferAttribute(sizes, 1));
          geometry.setAttribute('aType', new THREE.BufferAttribute(types, 1));

          const material = new THREE.ShaderMaterial({
            uniforms: {
              uTime: { value: 0 }, uMorph: { value: 0 }, uHeartMorph: { value: 0 }, uFlameState: { value: 0 },
              uPixelRatio: { value: renderer.getPixelRatio() }, uHeartColor: { value: CONFIG.colors.heart }, uHeartGlow: { value: CONFIG.colors.heartGlow }
            },
            vertexShader: `
              uniform float uTime; uniform float uMorph; uniform float uHeartMorph; uniform float uFlameState; uniform float uPixelRatio;
              attribute vec3 target; attribute vec3 heartTarget; attribute float size; attribute vec3 color; attribute float aType;
              varying vec3 vColor; varying float vAlpha;
              void main() {
                vec3 cakePos = mix(position, target, uMorph);
                vec3 currentPos = mix(cakePos, heartTarget, uHeartMorph);
                if (uMorph < 1.0 && uHeartMorph < 0.1) { currentPos.x += sin(uTime + position.y) * 0.2 * (1.0 - uMorph); currentPos.z += cos(uTime + position.x) * 0.2 * (1.0 - uMorph); }
                vColor = color; vAlpha = 1.0;
                if (aType > 1.5 && uHeartMorph < 0.1) { if (uFlameState < 0.1) { vAlpha = 0.0; } else { float flicker = sin(uTime * 20.0 + position.y * 10.0) * 0.05; currentPos.x += flicker; currentPos.z += flicker; vAlpha = 0.8 + 0.2 * sin(uTime * 15.0); } }
                vec4 mvPosition = modelViewMatrix * vec4(currentPos, 1.0);
                gl_Position = projectionMatrix * mvPosition;
                gl_PointSize = size * 1.5 * uPixelRatio * (25.0 / -mvPosition.z);
              }
            `,
            fragmentShader: `
              varying vec3 vColor; varying float vAlpha; uniform vec3 uHeartColor; uniform vec3 uHeartGlow; uniform float uHeartMorph;
              void main() {
                if (vAlpha < 0.01) discard;
                vec2 center = gl_PointCoord - 0.5;
                if (length(center) > 0.5) discard;
                float glow = 1.0 - (length(center) * 2.0); glow = pow(glow, 2.0);
                vec3 mixedColor = mix(vColor, uHeartColor, uHeartMorph);
                if (uHeartMorph > 0.5) { mixedColor = mix(mixedColor, uHeartGlow, glow * 0.5); }
                gl_FragColor = vec4(mixedColor, vAlpha * glow);
              }
            `,
            transparent: true, depthWrite: false, blending: THREE.AdditiveBlending
          });

          const particles = new THREE.Points(geometry, material);
          particlesRef.current = particles;
          scene.add(particles);

          const clock = new THREE.Clock();
          let rAF = 0;
          const animate = () => {
            const time = clock.getElapsedTime();
            material.uniforms.uTime.value = time;
            if (material.uniforms.uHeartMorph.value > 0.1) {
              controls.enabled = false; controls.autoRotate = false;
              camera.position.lerp(new THREE.Vector3(0, 0, 14), 0.05); camera.lookAt(0, 0, 0);
              particles.rotation.set(0, 0, 0); particles.scale.set(1, 1, 1);
            } else {
              controls.enabled = true; controls.autoRotate = true; controls.update();
              particles.rotation.set(0,0,0);
              if (material.uniforms.uMorph.value < 0.1) particles.rotation.y = time * 0.05;
            }
            renderer.render(scene, camera);
            rAF = requestAnimationFrame(animate);
          };
          animate();

          return () => { 
            cancelAnimationFrame(rAF); 
            if(rendererRef.current) rendererRef.current.dispose(); 
            if(geometry) geometry.dispose(); 
            if(controlsRef.current) controlsRef.current.dispose(); 
            stopCamera(); 
          };
        }, [stopCamera, CONFIG]);

        const triggerAction = useCallback((action) => {
          if (!particlesRef.current) return;
          const uniforms = particlesRef.current.material.uniforms;
          switch (action) {
            case 'HEART_MODE':
              setFeedback({icon: <Heart size={40} className="text-pink-500 fill-pink-500" />, text: "Love!"});
              gsap.to(uniforms.uMorph, { value: 1, duration: 0.5 });
              gsap.to(uniforms.uHeartMorph, { value: 1, duration: 2.0, ease: "elastic.out(1, 0.5)" });
              gsap.to(uniforms.uFlameState, { value: 0, duration: 0.5 });
              break;
            case 'CAKE_MODE':
              gsap.to(uniforms.uHeartMorph, { value: 0, duration: 1.5, ease: "power2.inOut" });
              break;
            case 'SCATTERED':
              setFeedback({icon: <Wind size={40} />, text: "Scattered!"});
              gsap.to(uniforms.uMorph, { value: 0, duration: 1.5, ease: "power2.inOut" });
              gsap.to(uniforms.uHeartMorph, { value: 0, duration: 1.0 });
              gsap.to(uniforms.uFlameState, { value: 0, duration: 0.5 });
              setSurpriseActive(false);
              break;
            case 'ASSEMBLED':
              if (uniforms.uMorph.value < 0.9) {
                setFeedback({icon: <Hand size={40} />, text: "Assembled!"});
                gsap.to(uniforms.uMorph, { value: 1, duration: 1.5, ease: "elastic.out(1, 0.8)" });
                gsap.to(uniforms.uHeartMorph, { value: 0, duration: 1.0 });
              }
              break;
            case 'LIT':
              setFeedback({icon: <Flame size={40} className="text-orange-500" />, text: "Lit!"});
              gsap.to(uniforms.uFlameState, { value: 1, duration: 0.5 });
              break;
            case 'EXTINGUISH':
              setFeedback({icon: <Wind size={40} className="text-blue-300" />, text: "Extinguished!"});
              gsap.to(uniforms.uFlameState, { value: 0, duration: 0.5 });
              break;
          }
          if(feedback) setTimeout(() => setFeedback(null), 2000);
        }, [feedback]);

        const onHandResults = (results) => {
          const { cakeState: currentCakeState, surpriseActive: currentSurpriseActive } = stateRef.current;

          if (!results.multiHandLandmarks || results.multiHandLandmarks.length === 0) {
             setHandVisible(false);
             setDetectedGesture('No Hand');
             return;
          }

          setHandVisible(true);
          const lm = results.multiHandLandmarks[0];

          const wrist = lm[0];
          
          const isExtended = (tipIdx, pipIdx) => {
             const dTip = Math.hypot(lm[tipIdx].x - wrist.x, lm[tipIdx].y - wrist.y);
             const dPip = Math.hypot(lm[pipIdx].x - wrist.x, lm[pipIdx].y - wrist.y);
             return dTip > dPip;
          };

          const indexExt = isExtended(8, 6);
          const middleExt = isExtended(12, 10);
          const ringExt = isExtended(16, 14);
          const pinkyExt = isExtended(20, 18);

          const pinchDist = Math.hypot(lm[4].x - lm[8].x, lm[4].y - lm[8].y);
          const isPinch = pinchDist < CONFIG.thresholds.pinchDist;

          const isPeace = indexExt && middleExt && !ringExt && !pinkyExt && !isPinch;
          
          const isFist = !indexExt && !middleExt && !ringExt && !pinkyExt && !isPinch;
          
          const isOpen = indexExt && middleExt && ringExt && pinkyExt && !isPinch;

          let currentGesture = 'Unknown';
          if (isPeace) currentGesture = 'PEACE';
          else if (isFist) currentGesture = 'FIST';
          else if (isOpen) currentGesture = 'OPEN';
          else if (isPinch) currentGesture = 'PINCH';
          
          setDetectedGesture(currentGesture);

          const now = Date.now();
          if (now - lastActionTime.current < 800) return;

          if (isPeace && !currentSurpriseActive) {
            setSurpriseActive(true);
            triggerAction('HEART_MODE');
            lastActionTime.current = now;
            return;
          }

          if (isFist) {
             if (currentSurpriseActive) {
                setSurpriseActive(false);
                setCakeState('ASSEMBLED');
                triggerAction('CAKE_MODE');
                lastActionTime.current = now;
             } else if (currentCakeState === 'SCATTERED') {
                setCakeState('ASSEMBLED');
                triggerAction('ASSEMBLED');
                lastActionTime.current = now;
             }
             return;
          }

          if (isPinch && currentCakeState === 'ASSEMBLED' && !currentSurpriseActive) {
             setCakeState('LIT');
             triggerAction('LIT');
             lastActionTime.current = now;
             return;
          }

          if (isOpen && currentCakeState !== 'SCATTERED' && !currentSurpriseActive) {
             setCakeState('SCATTERED');
             triggerAction('SCATTERED');
             lastActionTime.current = now;
             return;
          }
        };

        const startCamera = async () => {
          if (cameraActive.current) return;
          stopCamera();
          
          try {
              if (!window.Hands) throw new Error("MediaPipe Hands not loaded");

              const hands = new window.Hands({ locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}` });
              hands.setOptions({ maxNumHands: 1, modelComplexity: 1, minDetectionConfidence: 0.6, minTrackingConfidence: 0.5 });
              hands.onResults(onHandResults);
              handsRef.current = hands;

              const getStream = async (tries) => {
                  try {
                     return await navigator.mediaDevices.getUserMedia({ video: { width: 640, height: 480, facingMode: 'user' } });
                  } catch (err) {
                     if (tries > 0 && (err.name === 'NotReadableError' || err.name === 'TrackStartError')) {
                         console.warn("Camera busy, retrying in 1s...");
                         await new Promise(r => setTimeout(r, 1000));
                         return getStream(tries - 1);
                     }
                     throw err;
                  }
              };

              const stream = await getStream(1);
              streamRef.current = stream;
              
              if (videoRef.current) {
                  videoRef.current.srcObject = stream;
                  
                  await new Promise((resolve) => {
                      if (videoRef.current.readyState >= 1) resolve();
                      else videoRef.current.onloadedmetadata = () => resolve();
                  });
                  await videoRef.current.play();
                  
                  cameraActive.current = true;
                  setCameraAuthorized(true);
                  setCameraError(null);

                  const loop = async () => {
                      if (!cameraActive.current || !videoRef.current || !handsRef.current) return;
                      if(videoRef.current.readyState === 4 && !videoRef.current.paused && !videoRef.current.ended) {
                        try {
                           await handsRef.current.send({ image: videoRef.current });
                        } catch(e) { /* ignore tracking errors */ }
                      }
                      if (cameraActive.current) requestAnimationFrame(loop);
                  };
                  loop();
              }
          } catch (e) {
              console.error(e);
              let msg = "Camera denied";
              if (e.name === 'NotReadableError' || e.name === 'TrackStartError') msg = "Camera in use. Please close other apps.";
              else if (e.name === 'NotAllowedError') msg = "Permission denied";
              setCameraError(msg);
              cameraActive.current = false;
              stopCamera();
          }
        };

        const startMic = async () => {
          try {
            const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
            const ctx = new (window.AudioContext || window.webkitAudioContext)();
            const analyser = ctx.createAnalyser();
            ctx.createMediaStreamSource(stream).connect(analyser);
            analyser.fftSize = 256;
            analyserRef.current = analyser; setMicActive(true);
            const checkAudio = () => {
              if (analyserRef.current) {
                const data = new Uint8Array(analyserRef.current.frequencyBinCount);
                analyserRef.current.getByteFrequencyData(data);
                let sum = 0; for(let i=0; i<data.length; i++) sum += data[i];
                const avg = sum / data.length;
                
                // --- MODIFIED BLOW DETECTION ---
                // "Blowing" generates sustained noise across frequencies (white/pink noise)
                // Threshold lowered to 40 (out of 255) to be more sensitive to quieter microphones
                // Instead of resetting immediately on a "miss" (avg < 40), we decay the counter slowly.
                // This simulates "heat" buildup and allows for slightly fluctuating breath.
                
                if (avg > 40) {
                   blowTriggerCount.current++;
                   // Trigger count reduced to 20 frames (~0.3-0.4s) for faster response
                   if (blowTriggerCount.current > 20) { 
                      triggerAction('EXTINGUISH'); 
                      blowTriggerCount.current = 0; // Reset after trigger
                   }
                } else {
                   // Decay slowly instead of hard reset
                   // This allows the user to maintain progress if volume dips briefly
                   blowTriggerCount.current = Math.max(0, blowTriggerCount.current - 1);
                }
              }
              audioCheckRaf.current = requestAnimationFrame(checkAudio);
            };
            checkAudio();
          } catch(e) {}
        };

        return (
          <div className="relative w-full h-screen bg-black overflow-hidden select-none">
            <div ref={containerRef} className="absolute inset-0 z-10 cursor-pointer" onClick={() => {
                if(surpriseActive) { setSurpriseActive(false); setCakeState('ASSEMBLED'); triggerAction('CAKE_MODE'); }
                else if(cakeState === 'SCATTERED') triggerAction('ASSEMBLED');
                else if(cakeState === 'ASSEMBLED') triggerAction('LIT');
                else if(cakeState === 'LIT') triggerAction('EXTINGUISH');
            }} />
            <AnimatePresence>
              {surpriseActive && (
                <motion.div initial={{ opacity: 0, scale: 0.8 }} animate={{ opacity: 1, scale: 1 }} exit={{ opacity: 0, scale: 0.8 }} className="absolute inset-0 z-30 flex flex-col items-center justify-center pointer-events-none px-4">
                  <div className="text-center relative max-w-full translate-y-16">
                    <div className="absolute inset-0 bg-pink-500/20 blur-[60px] rounded-full"></div>
                    <motion.div className="text-6xl md:text-8xl font-black mb-2 tracking-wider relative z-10 font-hand pt-8 pb-4 leading-normal" style={{ background: 'linear-gradient(135deg, #FFE6F2 0%, #FF80B0 100%)', WebkitBackgroundClip: 'text', WebkitTextFillColor: 'transparent', filter: 'drop-shadow(0px 0px 15px rgba(255, 128, 176, 0.8))' }} animate={{ y: [0, -10, 0] }} transition={{ y: { duration: 3, repeat: Infinity, ease: "easeInOut" } }}>Â∞èÂè∂ÂêåÂ≠¶</motion.div>
                    <motion.div className="text-5xl md:text-7xl font-bold text-white relative z-10 font-hand mt-2 py-2 leading-relaxed" style={{ textShadow: '0 4px 10px rgba(255, 20, 147, 0.6)' }} animate={{ scale: [1, 1.05, 1] }} transition={{ duration: 2, repeat: Infinity, ease: "easeInOut" }}>ÁîüÊó•Âø´‰πê</motion.div>
                  </div>
                </motion.div>
              )}
            </AnimatePresence>
            <div className="absolute top-24 right-6 z-40 flex flex-col items-end gap-2">
              <div className={`relative w-48 aspect-[4/3] rounded-xl overflow-hidden border-2 border-white/20 shadow-2xl bg-black/80 transition-opacity duration-500 ${cameraAuthorized ? 'opacity-100' : 'opacity-90'}`}>
                <video ref={videoRef} className="absolute inset-0 w-full h-full object-cover opacity-60 mirror-x" playsInline muted />
                {!cameraAuthorized && !cameraError && <div className="absolute inset-0 flex flex-col items-center justify-center text-white/50 text-xs"><Camera size={20} /><span>Click Start Camera</span></div>}
                {cameraError && <div className="absolute inset-0 flex flex-col items-center justify-center text-red-400 bg-black/80 text-center p-2"><XCircle size={24} /><span className="text-xs font-bold mt-1">{cameraError}</span></div>}
              </div>
              <div className="bg-black/50 backdrop-blur-md px-3 py-1 rounded-lg border border-white/10 text-xs font-mono text-usagi-orange">
                 GESTURE: <span className="font-bold text-white uppercase">{detectedGesture}</span>
              </div>
            </div>
            <div className="absolute bottom-8 left-8 z-50 w-72 bg-white/10 backdrop-blur-xl p-5 rounded-2xl border border-white/20 text-white shadow-xl">
              <h3 className="font-bold text-usagi-orange mb-4 flex items-center gap-2 text-lg"><Sparkles size={18} fill="currentColor" /> Magic Controls</h3>
              <div className="flex flex-col gap-2 mb-4">
                {!cameraAuthorized && <button onClick={startCamera} className="w-full bg-usagi-main hover:bg-usagi-hover text-usagi-text font-bold py-2.5 rounded-xl flex items-center justify-center gap-2 transition-transform active:scale-95"><Camera size={18} /> Start Camera</button>}
                {!micActive && <button onClick={startMic} className="w-full bg-white/10 hover:bg-white/20 text-white font-bold py-2.5 rounded-xl flex items-center justify-center gap-2 border border-white/10 transition-colors"><Mic size={18} /> Enable Blow (Mic)</button>}
              </div>
              <div className="space-y-2 text-sm text-white/80 bg-black/20 p-3 rounded-xl">
                <div className="flex justify-between items-center"><span className="flex items-center gap-2">‚úåÔ∏è Peace</span><span className="font-mono text-[10px] bg-pink-500/20 px-1 rounded text-pink-300">SURPRISE!</span></div>
                <div className="flex justify-between items-center"><span className="flex items-center gap-2">‚úä Fist</span><span className="font-mono text-[10px] bg-white/10 px-1 rounded">ASSEMBLE</span></div>
                <div className="flex justify-between items-center"><span className="flex items-center gap-2">‚úã Open</span><span className="font-mono text-[10px] bg-white/10 px-1 rounded">SCATTER</span></div>
                <div className="flex justify-between items-center"><span className="flex items-center gap-2">üëå Pinch</span><span className="font-mono text-[10px] bg-orange-500/20 px-1 rounded text-orange-300">LIGHT FLAME</span></div>
                <div className="flex justify-between items-center"><span className="flex items-center gap-2">üå¨Ô∏è Blow</span><span className="font-mono text-[10px] bg-blue-500/20 px-1 rounded text-blue-300">EXTINGUISH</span></div>
              </div>
            </div>
            {feedback && <motion.div initial={{ opacity: 0, scale: 0.5, y: 20 }} animate={{ opacity: 1, scale: 1, y: 0 }} exit={{ opacity: 0, scale: 0.8, y: -20 }} className="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 z-[60] flex flex-col items-center gap-3 pointer-events-none"><div className="p-8 bg-black/70 backdrop-blur-lg rounded-full text-white shadow-2xl border-4 border-white/10">{feedback.icon}</div><span className="text-white font-bold text-2xl text-shadow-lg tracking-wide bg-black/40 px-4 py-1 rounded-lg backdrop-blur">{feedback.text}</span></motion.div>}
          </div>
        );
      };

       // SCENE 5: Outro
      const Scene5Outro = () => {
        const [message, setMessage] = useState("Wishing you happiness every day!");
        const [isEditing, setIsEditing] = useState(false);
        const captureRef = useRef(null);
        const [captured, setCaptured] = useState(false);
        const handleCapture = async () => {
          if (captureRef.current) {
            setCaptured(true);
            try {
              const canvas = await html2canvas(captureRef.current, { backgroundColor: null, scale: 2, useCORS: true });
              const link = document.createElement('a'); link.download = 'usagi-birthday-wish.png'; link.href = canvas.toDataURL('image/png'); link.click();
            } catch (err) {}
            setCaptured(false);
          }
        };
        return (
          <div className="w-full h-full flex flex-col items-center justify-center p-4 z-40 relative overflow-hidden">
            {/* 1. Background Atmosphere Upgrade: Falling Maple Leaves & Pumpkin Seeds */}
            <AutumnAtmosphere />
            <div className="absolute inset-0 pointer-events-none overflow-hidden z-0">
                <div className="absolute top-20 left-10 text-6xl opacity-60 rotate-12 animate-bounce-slow" style={{ left: 'calc(2.5rem + 30cm)' }}>üçÅ</div>
                <div className="absolute top-32 right-20 text-5xl opacity-50 -rotate-12 animate-pulse">‚ú®</div>
            </div>
            
            {/* Flex container for vertical layout */}
            <div className="relative w-full h-full flex flex-col items-center justify-center gap-4">
                
                {/* Card Container */}
                <div className="flex-grow flex items-center justify-center pt-8">
                  <div ref={captureRef} className="relative flex flex-col items-center justify-center p-12 rounded-[3rem] z-10 transform scale-[1.1] md:scale-[1.5]">
                    <div className="w-[28.8rem] h-[28.8rem] md:w-[38.4rem] md:h-[38.4rem] relative filter drop-shadow-xl" style={{ transform: 'translate(-4cm, -3.8cm) scale(0.72)' }}>
                        <UsagiCharacter 
                            action="hold-board" 
                            className="w-full h-full" 
                            boardText={message} 
                            imageSrc="https://test.fukit.cn/autoupload/f/IeSYb0Mnf1Z62nIKYGB4NyfNcKcqEnRmcljopnyJoMs/20251226/gYtT/3502X4232/nangua.png/webp"
                            isHeart={true}
                            boardVariant="pumpkin"
                        />
                        {/* 2. Character Optimization: Pumpkin Seeds at feet */}
                        <PumpkinSeeds />
                    </div>
                  </div>
                </div>

                {/* Buttons Container - Centered below card with gap */}
                <div className={`flex items-center gap-[1cm] z-50 -mt-[13cm] translate-x-[8.5cm] transition-opacity duration-300 ${isEditing ? 'opacity-0 pointer-events-none' : 'opacity-100'}`}>
                    <ParticleButton 
                        onClick={() => setIsEditing(true)}
                        className="rounded-[2rem] bg-gradient-to-r from-orange-300 to-pink-300 text-[#5D4037] px-6 py-3 md:px-8 md:py-4 shadow-btn-plush hover:shadow-btn-plush-active flex items-center gap-2 font-cute font-bold text-lg md:text-xl transform transition-transform"
                    >
                        <PenTool size={20} className="stroke-2" />
                        <span>Edit Wish</span>
                    </ParticleButton>

                    <ParticleButton 
                        onClick={handleCapture}
                        className="rounded-[2rem] bg-gradient-to-r from-orange-300 to-pink-300 text-[#5D4037] px-6 py-3 md:px-8 md:py-4 shadow-btn-plush hover:shadow-btn-plush-active flex items-center gap-2 font-cute font-bold text-lg md:text-xl transform transition-transform"
                    >
                        <Download size={20} className="stroke-2" />
                        <span>Save Card</span>
                    </ParticleButton>
                </div>
            </div>

            <AnimatePresence>
                {isEditing && (
                    <motion.div 
                        initial={{ opacity: 0, backdropFilter: "blur(0px)" }}
                        animate={{ opacity: 1, backdropFilter: "blur(5px)" }}
                        exit={{ opacity: 0, backdropFilter: "blur(0px)" }}
                        className="fixed inset-0 z-[60] flex items-center justify-center bg-black/20 p-4"
                    >
                        <motion.div 
                            initial={{ scale: 0.9, y: 20 }}
                            animate={{ scale: 1, y: 0 }}
                            exit={{ scale: 0.9, y: 20 }}
                            className="bg-white rounded-3xl p-6 w-full max-w-md shadow-2xl border-4 border-usagi-main"
                        >
                            <h3 className="text-xl font-bold text-usagi-text mb-4 text-center">Write a Wish ‚ú®</h3>
                            <textarea 
                                value={message} 
                                onChange={(e) => setMessage(e.target.value)} 
                                className="w-full p-4 border-2 border-usagi-orange/50 rounded-2xl font-creamy text-2xl focus:outline-none focus:border-usagi-orange min-h-[150px] resize-none" 
                                placeholder="Write your wish here..."
                            />
                            <div className="flex gap-3 mt-4">
                                <button onClick={() => setIsEditing(false)} className="flex-1 bg-gray-100 text-gray-500 font-bold py-3 rounded-xl hover:bg-gray-200">Cancel</button>
                                <button onClick={() => setIsEditing(false)} className="flex-1 bg-usagi-main text-usagi-text font-bold py-3 rounded-xl hover:bg-usagi-orange shadow-md">Done</button>
                            </div>
                        </motion.div>
                    </motion.div>
                )}
            </AnimatePresence>

            {captured && <motion.div initial={{ opacity: 0, y: 50 }} animate={{ opacity: 1, y: 0 }} className="fixed bottom-10 bg-usagi-text text-white px-8 py-4 rounded-full shadow-2xl z-[60] font-bold text-xl flex items-center gap-2"><span>üì∏</span> Saved!</motion.div>}
          </div>
        );
      };

      // --- APP ROOT ---
      const App = () => {
        const [scene, setScene] = useState('LOGIN');
        // Initialize muted to TRUE to match typical browser autoplay blocking policy.
        // This ensures the icon starts as "Mute", and user click turns it to "Sound" and plays audio.
        const [muted, setMuted] = useState(true);
        const bgmRef = useRef(null);
        
        // Handle BGM Logic for Scene Changes
        useEffect(() => {
           if(bgmRef.current) {
             bgmRef.current.volume = muted ? 0 : 0.4;
             
             if (scene === 'LOGIN') {
                // Do not play on login screen until user interaction (handled in handleLoginSuccess)
             } else if (scene === 'VINYL') {
                // Pause global BGM when entering Vinyl scene
                bgmRef.current.pause();
             } else {
                // Play for all other scenes if not muted
                if (!muted) {
                    const playPromise = bgmRef.current.play();
                    if (playPromise !== undefined) {
                        playPromise.catch(error => {
                            console.log("Auto-play was prevented. Interaction required.");
                        });
                    }
                }
             }
           }
        }, [scene, muted]);
        
        const toggleAudio = () => { 
            setMuted(!muted);
        };
        
        const start = () => { 
            // Ensure audio plays on user interaction
            if(bgmRef.current && !muted) bgmRef.current.play().catch(()=>{});
            setScene('PHOTO_WALL'); 
        };

        const playBGM = () => {
           if(bgmRef.current) {
              setMuted(false); // Automatically unmute on explicit play action
              bgmRef.current.play().catch(e => console.log("Manual play failed", e));
           }
        };
        
        const handleLoginSuccess = () => {
           setScene('INTRO');
        };

        const back = () => { 
          if(scene==='PHOTO_WALL') setScene('INTRO'); 
          if(scene==='WISHES') setScene('PHOTO_WALL'); 
          if(scene==='CAKE') setScene('WISHES'); 
          if(scene==='OUTRO') setScene('WISHES'); 
          if(scene==='VINYL') setScene('WISHES');
        };

        return (
          <div className="relative min-h-screen font-sans text-usagi-text overflow-hidden selection:bg-usagi-pink selection:text-white">
            {/* Global Background Music Element */}
            <audio ref={bgmRef} src={ASSETS.sounds.bgm} loop preload="auto" />

            {scene !== 'LOGIN' && scene !== 'VINYL' && <Background />}
            
            {scene !== 'LOGIN' && scene !== 'VINYL' && (
               <div className="fixed top-4 right-4 z-50"><button onClick={toggleAudio} className="bg-white/80 p-3 rounded-full shadow-md hover:bg-white border border-usagi-main">{muted ? <VolumeX size={24}/> : <Volume2 size={24}/>}</button></div>
            )}
            
            <BackButton onClick={back} disabled={scene==='INTRO' || scene==='LOGIN'} scene={scene} />
            
            <AnimatePresence mode="wait">
              {scene === 'LOGIN' && <Scene0Login key="login" onLogin={handleLoginSuccess} playBGM={playBGM} />}
              {scene === 'INTRO' && <Scene1Intro key="intro" onStart={start} />}
            </AnimatePresence>
            
            {scene !== 'INTRO' && scene !== 'LOGIN' && scene !== 'VINYL' && <div className={`absolute inset-0 z-0 flex items-center justify-center transition-opacity duration-500 ${scene==='CAKE'?'opacity-20':'opacity-100'}`}><Scene2PhotoWall isActive={scene==='PHOTO_WALL'} onNext={()=>setScene('WISHES')} showButton={scene==='PHOTO_WALL'} isBackgroundMode={scene!=='PHOTO_WALL'} /></div>}
            
            <AnimatePresence>
              {scene === 'WISHES' && <motion.div key="wishes" className="absolute inset-0 z-10" initial={{opacity:0}} animate={{opacity:1}} exit={{opacity:0}}><Scene3Wishes onGoToCakeInteraction={()=>setScene('CAKE')} onGoToOutro={()=>setScene('OUTRO')} onGoToVinyl={() => setScene('VINYL')} /></motion.div>}
              
              {scene === 'CAKE' && <motion.div key="cake" className="absolute inset-0 z-20 bg-black/60 backdrop-blur-sm" initial={{opacity:0}} animate={{opacity:1}} exit={{opacity:0}}><Scene4CakeInteraction /></motion.div>}
              {scene === 'OUTRO' && <motion.div key="outro" className="absolute inset-0 z-20" initial={{opacity:0}} animate={{opacity:1}} exit={{opacity:0}}><Scene5Outro /></motion.div>}
              {scene === 'VINYL' && <motion.div key="vinyl" className="absolute inset-0 z-30" initial={{opacity:0}} animate={{opacity:1}} exit={{opacity:0}}><SceneVinylPlayer /></motion.div>}
            </AnimatePresence>
          </div>
        );
      };

      const root = createRoot(document.getElementById('root'));
      root.render(<App />);
    </script>
  </body>
</html>
